# MindLog v1.1 — Master To-Do List

**For:** Claude Code agent
**Plan reference:** [V1.1_DEVELOPMENT_PLAN.md](V1.1_DEVELOPMENT_PLAN.md)
**Status key:** `[ ]` not started · `[~]` in progress · `[x]` complete · `[!]` blocked

> Tick items off as work is completed. Every checkbox maps to a concrete file change or
> verifiable outcome. Sections can be handed to the agent one phase at a time.

---

## Pre-work (do before any phase starts)

- [x] Read `V1.1_DEVELOPMENT_PLAN.md` fully (already done — this list was derived from it)
- [x] Run `npm install` from repo root and confirm clean build: `npx turbo run build`
- [ ] Confirm all 8 existing migrations are applied: `SELECT name FROM schema_migrations ORDER BY name`
- [ ] Confirm demo seed works: login as `dr.kim@mindlogdemo.com` via API
- [ ] Confirm `ANTHROPIC_API_KEY` is present in `.env` (needed for Phase 3 and docs-agent)
- [ ] Confirm `RESEND_API_KEY` is present in `.env` (needed for Phase 1)

---

## Phase 1 — Patient Registration & Onboarding

### 1-A  Database — verify migration 008 indexes

- [x] Read `packages/db/migrations/008_patient_invites.sql`
- [x] Check: index `idx_patient_invites_token_pending` exists (`WHERE status = 'pending'`)
- [x] Check: index `idx_patient_invites_clinician_status` exists
- [x] Check: index `idx_patients_invite_id` exists
- [x] If any are missing, add them to a new file `packages/db/migrations/008b_invite_indexes.sql`
- [x] Check `patients` table has columns: `primary_concern`, `emergency_contact_name`, `emergency_contact_phone`, `emergency_contact_relationship`, `intake_complete`, `invite_id`
- [x] Check `patients` table has `supabase_uid` column (needed to store Supabase auth UUID separately from `patients.id`)
- [x] If `supabase_uid` is missing, add it in `009_passive_health.sql` (first line of that migration)

### 1-B  Shared schemas

- [x] Read `packages/shared/src/schemas/index.ts` in full
- [x] Add `CreateInviteSchema` (`email`, `personal_message?`)
- [x] Add `RegisterSchema` (`invite_token`, `email`, `password ≥12`, `first_name`, `last_name`, `date_of_birth`, `timezone`)
- [x] Add `IntakeSchema` (`primary_concern?`, `emergency_contact_*?`, `mark_complete?`)
- [x] Re-export all three from the package index
- [x] Run `npm run build --workspace=packages/shared` — must compile cleanly

### 1-C  Messaging service

- [x] Create `apps/api/src/services/messaging.ts`
- [x] Implement `sendInviteEmail()` using `resend` client
  - [x] Subject line: `{orgName} — Your clinician has invited you to MindLog`
  - [x] Deep link CTA: `mindlog://invite?token={token}`
  - [x] Expiry date shown clearly
  - [x] Crisis line footer from env vars
  - [x] HTML template as tagged template literal (no external dep)
  - [x] Plain-text fallback
- [x] Implement `sendWelcomeEmail()` using `resend` client
  - [x] Mentions clinician name
- [x] Add null-guard: if `RESEND_API_KEY` is not set, log a warning and return (do not throw — allows dev without email)

### 1-D  Invite routes

- [x] Create `apps/api/src/routes/invites/index.ts`
- [x] Implement `POST /invites`
  - [x] Validate `CreateInviteSchema`
  - [x] Check email not already a patient (409 if so)
  - [x] Check no existing pending invite from this clinician to this email (409 if so)
  - [x] Insert `patient_invites` row
  - [x] Call `sendInviteEmail()`
  - [x] Write `audit_logs`
  - [x] Return 201 with `{ id, email, expires_at }`
- [x] Implement `GET /invites`
  - [x] Returns clinician's invites, newest first
  - [x] Includes `status`, `email`, `created_at`, `expires_at`, `resend_count`
- [x] Implement `GET /invites/validate/:token` (PUBLIC — no auth)
  - [x] Returns `{ clinician_name, org_name, email, expires_at }` if pending + not expired
  - [x] Returns 404 with `code: INVITE_EXPIRED` if expired
  - [x] Returns 404 with `code: INVITE_USED` if accepted/cancelled
  - [x] Returns 404 with `code: INVITE_NOT_FOUND` if no row
- [x] Implement `POST /invites/:id/resend`
  - [x] Check `resend_count < 3` (429 if exceeded)
  - [x] Bump `expires_at` by 7 days from now
  - [x] Update `resent_at`, increment `resend_count`
  - [x] Call `sendInviteEmail()` again
- [x] Implement `DELETE /invites/:id`
  - [x] Only cancels own invites, only if `status = 'pending'`
  - [x] Sets `status = 'cancelled'`
  - [x] Write `audit_logs`
- [x] Register route in `apps/api/src/routes/index.ts`: `fastify.register(inviteRoutes, { prefix: '/invites' })`

### 1-E  Patient registration endpoint

- [x] Read `apps/api/src/routes/auth.ts` in full
- [x] Add `POST /auth/register` route (public, no JWT)
- [x] Implement full 12-step transaction:
  - [x] Step 1: Validate `RegisterSchema`
  - [x] Step 2: Fetch invite — 400 `INVITE_EXPIRED` if not found/expired
  - [x] Step 3: Check `patients.email` not taken — 409 if exists
  - [x] Step 4: `supabase.auth.admin.createUser({ email, password, email_confirm: true })`
  - [x] Step 5: `INSERT INTO patients` — new UUID (NOT Supabase auth UUID); store Supabase UID in `supabase_uid`
  - [x] Step 6: `UPDATE patient_invites SET status='accepted', patient_id=..., accepted_at=NOW()`
  - [x] Step 7: `INSERT INTO care_team_members` (patient, clinician from invite, role='primary')
  - [x] Step 8: `INSERT INTO consent_records` × 2 (terms_of_service, privacy_policy, granted=TRUE)
  - [x] Step 9: `INSERT INTO audit_logs`
  - [x] Step 10: `sendWelcomeEmail()`
  - [x] Step 11: `rulesQueue.add('patient_registered', { clinicianId, patientId })`
  - [x] Step 12: Return `{ access_token, refresh_token, user }` — same shape as login
- [x] Confirm `patients.id` (NOT Supabase UUID) becomes the JWT `sub` — matches existing auth pattern

### 1-F  Patient intake endpoint

- [x] Read `apps/api/src/routes/patients/me.ts` in full
- [x] Add `PATCH /patients/me/intake` route
  - [x] Validate `IntakeSchema`
  - [x] `UPDATE patients SET ... WHERE id = req.user.id`
  - [x] If `mark_complete = true`, also `SET intake_complete = TRUE`
  - [x] Write `audit_logs`
  - [x] Return updated patient row

### 1-G  Nightly scheduler — expire invites

- [x] Read `apps/api/src/workers/nightly-scheduler.ts` in full
- [x] Add step: `UPDATE patient_invites SET status='expired' WHERE status='pending' AND expires_at < NOW()`
- [x] Place before existing snapshot generation logic

### 1-H  Mobile — deep link wiring

- [x] Read `apps/mobile/app.json`
- [x] Add `"scheme": "mindlog"` at the `expo` root level (if not present)
- [x] Add Android `intentFilters` for `mindlog://invite`
- [x] Add iOS URL scheme for `mindlog`
- [x] Read `apps/mobile/app/_layout.tsx` in full
- [x] Add `expo-linking` import
- [x] Add `useEffect` for deep link handling:
  - [x] `Linking.getInitialURL()` on mount
  - [x] `Linking.addEventListener('url', handler)` — clean up in return
  - [x] If URL matches `mindlog://invite?token=*` → `router.replace('/onboarding?token=...')`
- [x] Extend existing auth navigation `useEffect` to also check `intakeComplete`:
  - [x] If `authenticated && role === 'patient' && !intakeComplete` → `router.replace('/onboarding-consent')`
  - [x] Call this AFTER `setReady(true)` (per existing memory note about navigation timing)

### 1-I  Mobile — auth service updates

- [x] Read `apps/mobile/services/auth.ts` in full
- [x] Add `INTAKE_COMPLETE: 'mindlog_intake_complete'` to `KEYS` object
- [x] In `storeSession()`: if session includes `intake_complete`, store it
- [x] Add `getIntakeComplete(): Promise<boolean>` helper
- [x] In `clearSession()`: delete `INTAKE_COMPLETE` key

### 1-J  Mobile — onboarding registration tab

- [x] Read `apps/mobile/app/onboarding.tsx` in full
- [x] Add two-tab toggle at top: "Sign In" | "Create Account"
  - [x] Use existing dark card styling
  - [x] Animate tab indicator with `Animated` (same pattern as existing animated elements)
- [x] Build "Create Account" form:
  - [x] **Invite Code** input — auto-fill from `useLocalSearchParams().token`
  - [x] Invite Code blur handler → `GET /invites/validate/:token` → show "✓ Invited by Dr. {Name}" or red error
  - [x] **First Name** + **Last Name** side-by-side in a row
  - [x] **Date of Birth** — DD/MM/YYYY format, parse on blur, validate age ≥ 18
  - [x] **Email** — pre-fill from invite validate response, editable
  - [x] **Password** — min 12 chars, inline colour bar (red < 3 char classes / yellow = 3 / green = 4+)
  - [x] **Confirm Password** — must match
  - [x] **Create Account** CTA → `POST /auth/register` → `storeSession()` → `router.replace('/onboarding-consent')`
- [x] Error handling: dismissable banner for network/API errors; red border + inline text for field errors

### 1-K  Mobile — consent wizard

- [x] Create `apps/mobile/app/onboarding-consent.tsx`
- [x] Three screens with `Animated.timing` slide transitions (200ms — copy pattern from `checkin.tsx`)
- [x] **Screen 1 — Welcome**
  - [x] `LinearGradient` header (`#1a1f35` → `#161a27`)
  - [x] "Welcome, {firstName}!" from `getStoredUser()`
  - [x] Brief intro paragraph naming clinician
  - [x] "Get Started →" button
- [x] **Screen 2 — Required Consents**
  - [x] Terms of Service scrollable card + "I Agree" button → `POST /consent { consent_type: 'terms_of_service', granted: true }`
  - [x] Privacy Policy / HIPAA Notice scrollable card + "I Agree" button → `POST /consent { consent_type: 'privacy_policy', granted: true }`
  - [x] "Continue" only enabled once both agreed
  - [x] "Both are required to use MindLog" caption
- [x] **Screen 3 — Optional Consents**
  - [x] **Research Data** toggle → `POST /consent { consent_type: 'data_research', granted: true/false }`
  - [x] **AI Insights** toggle — only rendered if `EXPO_PUBLIC_AI_INSIGHTS_ENABLED=true`
  - [x] "Continue →" → `router.replace('/onboarding-intake')`

### 1-L  Mobile — intake wizard

- [x] Create `apps/mobile/app/onboarding-intake.tsx`
- [x] Segmented progress bar (1 segment per step — copy pattern from `checkin.tsx`)
- [x] Back button from step 2 onward
- [x] **Step 1 — Primary Concern** (required)
  - [x] 2-column card grid (Depression, Anxiety, Bipolar, PTSD, ADHD, Sleep, Other)
  - [x] "Other" reveals text input
  - [x] On select → `PATCH /patients/me/intake { primary_concern }`
- [x] **Step 2 — Current Medications** (skippable)
  - [x] Debounced search (300ms) → `GET /catalogues/medications?search=`
  - [x] Tap to add with dose + frequency inline
  - [x] Removable chips
  - [x] "Skip — I'm not taking medications" link
  - [x] On confirm → `POST /medications` per item
- [x] **Step 3 — Symptoms** (skippable)
  - [x] Multi-select chip grid from `GET /catalogues/symptoms?is_safety_symptom=false`
  - [x] On select → `POST /patients/me/symptoms`
- [x] **Step 4 — Triggers** (skippable)
  - [x] Multi-select chip grid from `GET /catalogues/triggers`
  - [x] On select → `POST /patients/me/triggers`
- [x] **Step 5 — Emergency Contact** (skippable — "Add Later" button)
  - [x] Name, Phone (country code prefix), Relationship (dropdown: Partner/Parent/Sibling/Friend/Therapist/Other)
  - [x] Helper text about sharing condition
  - [x] On save → `PATCH /patients/me/intake { emergency_contact_* }`
- [x] **Step 6 — Daily Reminders** (NOT skippable)
  - [x] Time picker (default: 20:00)
  - [x] Medication reminder toggle (only if meds added in Step 2)
  - [x] "Enable Notifications" → `expo-notifications` permission request
  - [x] On confirm → `POST /notifications/prefs` then `PATCH /patients/me/intake { mark_complete: true }`
- [x] **Step 7 — You're All Set!**
  - [x] Spring-animated checkmark (`Animated.spring` — copy from Today quick-mood buttons)
  - [x] "You're ready, {firstName}!"
  - [x] "Start My First Check-in" → `router.replace('/(tabs)')` then `router.push('/checkin')`
  - [x] "Explore the app first" → `router.replace('/(tabs)')`

### 1-M  Web — complete invite modal wiring

- [x] Read `apps/web/src/components/InvitePatientModal.tsx` in full
- [x] Add `useMutation` calling `POST /api/v1/invites`
- [x] Email validation (required), personal message max 500 chars with live counter
- [x] Success state: toast + close + invalidate `invites` query
- [x] Error states: 409 already registered, 409 duplicate pending, 429 rate limit

### 1-N  Web — PatientsPage invite integration

- [x] Read `apps/web/src/pages/PatientsPage.tsx` in full
- [x] Wire "Invite Patient" button to open `InvitePatientModal`
- [x] Fetch `GET /invites` alongside patient list
- [x] Show ⏳ **Pending** badge for invitees with `status = 'pending'`
- [x] Clicking pending badge → action popover with "Resend" and "Cancel"

### 1-O  Web — PatientDetailPage invite status card

- [x] Read `apps/web/src/pages/PatientDetailPage.tsx` in full
- [x] Add "Invite Status" card in Overview tab (only if `patient.invite_id` set)
  - [x] Pending: sent date, expiry, "Resend Invite" button
  - [x] Accepted: accepted date + green badge
  - [x] Expired: red badge + "Resend Invite" button

### 1-P  Phase 1 end-to-end verification

- [ ] `POST /invites` → row in DB, email in Resend dashboard ✓
- [ ] `GET /invites/validate/:token` (valid) → returns clinician name ✓
- [ ] `GET /invites/validate/:expired-token` → 404 `INVITE_EXPIRED` ✓
- [ ] `POST /auth/register` (valid token) → `access_token` returned ✓
- [ ] `patients` row created with new UUID (not Supabase UUID) ✓
- [ ] `care_team_members` row created ✓
- [ ] 2× `consent_records` rows created ✓
- [ ] Second `POST /auth/register` with same token → 409 ✓
- [ ] Android deep link: `adb shell am start ... mindlog://invite?token=XXX` → opens registration tab with token ✓
- [ ] Full mobile flow: invite → register → consent wizard → intake wizard → Today tab ✓
- [ ] Login as registered patient with `intake_complete=FALSE` → redirected to consent wizard ✓
- [ ] Web: clinician sends invite → patient shows ⏳ Pending ✓

---

## Phase 2 — Mobile Clinical Depth

### 2-A  Database — migration 009 (passive health)

- [x] Create `packages/db/migrations/009_passive_health.sql`
- [x] Create `passive_health_snapshots` table (see plan §6.2 for full schema)
  - [x] Columns: `id`, `patient_id`, `snapshot_date`, `source`, `step_count`, `active_calories`, `resting_hr`, `hrv_ms`, `sleep_hours`, `sleep_deep_pct`, `sleep_rem_pct`, `o2_saturation`, `created_at`
  - [x] Unique constraint: `(patient_id, snapshot_date, source)`
  - [x] Index on `(patient_id, snapshot_date DESC)`
- [x] If `supabase_uid` column not already in patients, add it here:
  - `ALTER TABLE patients ADD COLUMN IF NOT EXISTS supabase_uid UUID;`
- [x] Apply migration and confirm: `\d passive_health_snapshots`

### 2-B  API — voice transcription route

- [x] Create `apps/api/src/routes/voice/index.ts`
- [x] `POST /voice/transcribe`
  - [x] Patient JWT required
  - [x] Accept `multipart/form-data` with `audio` field (m4a, mp3, wav, max 25 MB)
  - [x] Add `@fastify/multipart` plugin if not already registered
  - [x] Rate limit: 5 transcriptions/hour per patient (Redis counter with TTL)
  - [x] Call OpenAI Whisper API: `POST https://api.openai.com/v1/audio/transcriptions`
  - [x] Return `{ transcript: string, duration_seconds: number }`
  - [x] Write `audit_logs` — action `voice_transcription`, no transcript stored
  - [x] If `OPENAI_API_KEY` not set → 503 "Voice transcription not enabled"
- [x] Register in `apps/api/src/routes/index.ts`
- [x] Add `OPENAI_API_KEY` to `.env.example`

### 2-C  API — health data sync route

- [x] Create `apps/api/src/routes/health-data/index.ts`
- [x] `POST /health-data/sync`
  - [x] Patient JWT required
  - [x] Accept array of `passive_health_snapshots` (validate with Zod)
  - [x] Upsert: `INSERT ... ON CONFLICT (patient_id, snapshot_date, source) DO UPDATE SET ...`
  - [x] Return `{ synced: number, skipped: number }`
- [x] Register in `apps/api/src/routes/index.ts`

### 2-D  Shared — health data schema

- [x] Add `PassiveHealthSnapshotSchema` to `packages/shared/src/schemas/index.ts`
- [x] Add `VoiceTranscribeSchema` for the upload endpoint

### 2-E  Mobile — VoiceRecorder component

- [x] Create `apps/mobile/components/VoiceRecorder.tsx`
- [x] Add `expo-av` dependency (confirm it's already in Expo SDK — check package.json)
- [x] Request microphone permission via `Audio.requestPermissionsAsync()` on first tap
- [x] Start/stop recording controls
- [x] Animated red dot when recording (500ms pulse via `Animated.loop + Animated.sequence`)
- [x] Amplitude meter: 20 vertical bars via `onAudioSampleReceived`
- [x] Max duration: 5 minutes; show countdown from 4:30
- [x] "Send for transcription" button → `POST /voice/transcribe` → insert transcript into parent text area via callback prop
- [x] "Discard" button

### 2-F  Mobile — journal voice integration

- [x] Read `apps/mobile/app/(tabs)/journal.tsx` in full
- [x] Add microphone button to new-entry prompt card
- [x] Tapping microphone → renders `<VoiceRecorder onTranscript={(text) => setBody(text)} />`
- [x] Show "✏️ Edit transcript" hint after transcript is inserted

### 2-G  Mobile — HealthKit / Health Connect service

- [x] Create `apps/mobile/services/healthData.ts`
- [x] Add `react-native-health` and `react-native-health-connect` to `apps/mobile/package.json`
- [x] Add plugin config to `app.json` (HealthKit entitlement, Health Connect permissions)
- [x] Implement `requestPermissions(): Promise<boolean>`
- [x] Implement `fetchDailySnapshot(date: Date): Promise<PassiveHealthSnapshot | null>`
  - [x] iOS: fetch steps, resting HR, HRV, sleep from HealthKit
  - [x] Android: fetch same from Health Connect API 35
- [x] Implement `syncToApi(snapshots: PassiveHealthSnapshot[]): Promise<void>` → `POST /health-data/sync`
- [x] On app foreground (`AppState` listener): call `fetchDailySnapshot(today)` + `fetchDailySnapshot(yesterday)` → `syncToApi()`

### 2-H  Mobile — Today screen passive health card

- [x] Read `apps/mobile/app/(tabs)/index.tsx` in full
- [x] After mood row, add "Today's Activity" summary card (only if health data available and permissions granted)
- [x] Show: step count (with progress toward 10,000 goal), sleep hours from last night, resting HR
- [x] "Connect Apple Health / Google Health" prompt if permissions not granted
- [x] Tapping the prompt → calls `healthData.requestPermissions()`

### 2-I  Mobile — insights passive health correlations

- [~] Read `apps/api/src/routes/insights/index.ts`
- [~] Add to `GET /insights/me` response: `passiveHealthCorrelations`
  - [ ] `stepsVsMood`: 7-day Pearson r between step count and next-day mood
  - [ ] `sleepHoursVsMood`: same for sleep hours
- [~] Read `apps/mobile/app/(tabs)/insights.tsx`
- [~] Add correlation cards for passive health (only rendered if data exists)

### 2-J  Dark mode — design tokens

- [x] Read `apps/mobile/constants/DesignTokens.ts` in full
- [x] Add `DARK_TOKENS` export with dark palette
- [x] Add `LIGHT_TOKENS` export

### 2-K  Dark mode — useColorScheme hook

- [x] Create `apps/mobile/hooks/useColorScheme.ts`
- [x] Wraps RN `useColorScheme()`
- [x] Reads user override from SecureStore (`COLOR_SCHEME_OVERRIDE` key)
- [x] Returns `'light' | 'dark'` based on override → fallback to system
- [x] Export `useTheme()` hook that returns `{ colors: typeof DesignTokens, isDark: boolean }`

### 2-L  Dark mode — settings toggle

- [x] Read `apps/mobile/app/settings/index.tsx` in full
- [x] Add "Appearance" section with three options: System / Light / Dark
- [x] Save selection to SecureStore `COLOR_SCHEME_OVERRIDE`

### 2-M  Dark mode — apply to all screens

- [~] Replace hardcoded `DESIGN_TOKENS.COLOR_*` references with `useTheme().colors.*` in:
  - [x] `app/(tabs)/index.tsx`
  - [x] `app/(tabs)/insights.tsx`
  - [x] `app/(tabs)/journal.tsx`
  - [ ] `app/(tabs)/profile.tsx`
  - [x] `app/checkin.tsx`
  - [x] `app/medications.tsx`
  - [ ] `app/assessments/[scale].tsx`
  - [x] `app/settings/index.tsx`
  - [ ] `app/settings/notifications.tsx`
  - [x] `app/onboarding.tsx`
  - [ ] All new screens from Phase 1 (onboarding-consent, onboarding-intake)

### 2-N  Accessibility (WCAG 2.1 AA)

- [x] Create `apps/mobile/utils/a11y.ts`
  - [x] `moodLabel(score: number): string` — "Mood score {n} out of 10"
  - [x] `dateRangeLabel(start, end): string`
  - [x] `medicationLabel(med): string`
- [ ] Audit every screen for missing `accessibilityLabel` on `Image` and icon components
- [ ] Audit every interactive element for `accessible={true}` + `accessibilityRole`
- [ ] Audit every toggle/checkbox for `accessibilityState`
- [ ] Verify all text meets 4.5:1 contrast ratio against backgrounds (both light and dark mode)
- [ ] Verify all touch targets ≥ 44×44 pt (update `Card.tsx` and `SkeletonCard.tsx` if needed)
- [ ] Add `accessibilityLabel` to all emoji-only elements (quick-mood buttons, medication status icons)

### 2-O  EAS build config

- [x] Read `apps/mobile/eas.json`
- [x] Rewrite with proper `development`, `preview`, and `production` profiles (see plan §6.5)
- [x] Add `"submit"` block for Android (serviceAccountKeyPath) and iOS (appStoreConnect IDs)
- [x] Add build scripts to root `package.json`:
  - [x] `"build:mobile:preview": "eas build --profile preview --platform all"`
  - [x] `"build:mobile:production": "eas build --profile production --platform all"`
  - [x] `"submit:mobile": "eas submit --profile production --platform all"`
- [ ] Document required EAS secrets in `INSTALLER.sh` (Phase 6 item, note it here)

---

## Phase 3 — AI-Powered Clinical Intelligence

> ⚠️ REQUIRES `ANTHROPIC_BAA_SIGNED=true` before any patient data is sent to Anthropic.
> All AI endpoints and workers must remain inert until this flag is set.

### 3-A  Database — migration 010 (AI insights)

- [x] Create `packages/db/migrations/010_ai_insights.sql`
- [x] Create `patient_ai_insights` table (see plan §7.2 for full schema)
  - [x] Columns: `id`, `patient_id`, `insight_type`, `week_of`, `daily_entry_id`, `model_id`, `prompt_tokens`, `completion_tokens`, `narrative`, `key_findings` (JSONB), `risk_delta`, `consent_given`, `generated_at`
  - [x] Constraint: `CHECK (consent_given = TRUE)`
  - [x] Indexes on `(patient_id, generated_at DESC)` and `(patient_id, insight_type, week_of)`
- [x] Create `ai_usage_log` table
  - [x] Columns: `id`, `patient_id`, `month`, `prompt_tokens_total`, `completion_tokens_total`, `inference_count`, `updated_at`
  - [x] Unique: `(patient_id, month)`
- [x] Apply and confirm

### 3-B  Database — migration 011 (risk score + search)

- [x] Create `packages/db/migrations/011_search_risk_score.sql`
- [x] `ALTER TABLE patients ADD COLUMN IF NOT EXISTS risk_score SMALLINT DEFAULT 0`
- [x] `ALTER TABLE patients ADD COLUMN IF NOT EXISTS risk_score_factors JSONB`
- [x] `ALTER TABLE patients ADD COLUMN IF NOT EXISTS risk_score_updated_at TIMESTAMPTZ`
- [x] `ALTER TABLE clinician_notes ADD COLUMN IF NOT EXISTS search_vector TSVECTOR`
- [x] Create `tsvector` update trigger on `clinician_notes.body`
- [x] `CREATE INDEX ON clinician_notes USING GIN (search_vector)`
- [x] Apply and confirm

### 3-C  AI feature gate middleware

- [x] Create `apps/api/src/middleware/aiGate.ts`
- [x] Implement `requireAiEnabled(fastify)` pre-handler
  - [x] Returns 503 if `AI_INSIGHTS_ENABLED !== 'true'`
  - [x] Returns 503 if `ANTHROPIC_BAA_SIGNED !== 'true'`
  - [x] Response includes clear error code and human-readable message

### 3-D  Risk scoring service

- [x] Create `apps/api/src/services/riskScoring.ts`
- [x] Define `RiskScore` and `RiskFactor` interfaces
- [x] Implement `calculateRiskScore(patientId, sql): Promise<RiskScore>`:
  - [x] Fetch last 14 daily entries, latest PHQ-9, GAD-7, ASRM, adherence logs
  - [x] Apply 7 factors (see plan §7.7 for weights)
  - [x] Return score (0–100) + band (`low/moderate/elevated/high/crisis`) + factor list
- [x] Call from daily entry submit handler
- [x] Store result in `patients.risk_score`, `.risk_score_factors`, `.risk_score_updated_at`
- [x] Create `clinical_alert` if score crosses a band boundary (e.g., elevated → high)

### 3-E  AI inference worker

- [x] Create `apps/api/src/workers/ai-insights-worker.ts`
- [x] Register queue `mindlog-ai-insights` in BullMQ
- [x] Implement `generate_weekly_summary` job:
  - [x] Check patient has AI consent (`consent_records WHERE consent_type='ai_insights' AND granted=TRUE`)
  - [x] Build de-identified input (no name/email/MRN — only clinical values)
  - [x] Call `claude-sonnet-4-6` with `temperature: 0.3`, `max_tokens: 800`
  - [x] HIPAA preamble in system prompt
  - [x] Parse response → write `patient_ai_insights` row
  - [x] Update `ai_usage_log` (upsert by patient + month)
- [x] Implement `generate_trend_narrative` job (triggered after daily entry submit)
- [x] Implement `detect_anomaly` job (temperature 0.0, max_tokens 200)
  - [x] If anomaly detected: `INSERT INTO clinical_alerts (alert_type='ai_anomaly', ...)`
- [x] Implement `risk_stratification` job (nightly batch)
  - [x] Updates `patients.risk_level` based on AI reasoning
- [x] Wrap every job in consent check — skip (not error) if no consent

### 3-F  Nightly scheduler — AI jobs

- [x] Read `apps/api/src/workers/nightly-scheduler.ts`
- [x] Add (Sunday only): enqueue `generate_weekly_summary` for all patients with AI consent
- [x] Add (every night): enqueue `risk_stratification` for all active patients
- [x] Guard both with `AI_INSIGHTS_ENABLED === 'true'` check

### 3-G  API — AI insights endpoints

- [x] Read `apps/api/src/routes/insights/index.ts` in full
- [x] Add `GET /insights/me/ai?type=weekly_summary`
  - [x] Registers `requireAiEnabled` pre-handler
  - [x] Returns latest matching `patient_ai_insights` row
- [x] Add `GET /insights/me/ai/history`
  - [x] Returns last 12 weekly summaries (patient's own)
- [x] Add `POST /insights/:patientId/ai/trigger` (clinician)
  - [x] Requires care-team membership
  - [x] Enqueues `generate_weekly_summary` job immediately
  - [x] Returns 202 `{ jobId, message: 'Analysis queued' }`
- [x] Add `GET /insights/:patientId/ai` (clinician)
  - [x] Returns latest AI narrative for patient
  - [x] Includes `narrative`, `keyFindings`, `riskDelta`, disclaimer

### 3-H  Mobile — AI insights section

- [x] Read `apps/mobile/app/(tabs)/insights.tsx` in full
- [x] Add "AI Weekly Summary" section at bottom of screen
  - [x] Only rendered if `EXPO_PUBLIC_AI_INSIGHTS_ENABLED=true` AND patient has `ai_insights` consent
  - [x] Gradient header card (teal-to-navy, Fraunces serif font)
  - [x] Key findings as pills (red/amber/teal by severity)
  - [x] "Generated {time} ago" caption
  - [x] Tap → bottom sheet with full narrative

### 3-I  Web — AI tab on Patient Detail

- [x] Read `apps/web/src/pages/PatientDetailPage.tsx` in full (may have been read already)
- [x] Add 5th tab: "AI Insights"
  - [x] Hide entire tab if server returns `ai_insights_enabled: false`
  - [x] Weekly narrative card with risk delta badge (↑ / → / ↓)
  - [x] Key findings list
  - [x] Historical weekly summaries accordion (last 12 weeks)
  - [x] "Request new analysis" button → `POST /insights/:id/ai/trigger`
  - [x] HIPAA disclaimer footer on the tab

---

## Phase 4 — EHR Interoperability & FHIR R4

### 4-A  Database — migration 012 (research exports)

- [x] Create `packages/db/migrations/012_research_exports.sql`
- [x] Create `research_exports` table
- [x] Create `cohort_definitions` table
- [x] Apply and confirm

### 4-B  Database — migration 013 (crisis safety plan)

- [x] Create `packages/db/migrations/013_crisis_safety_plan.sql`
- [x] Create `crisis_safety_plans` table (see plan §11.3 for full schema)
- [x] Apply and confirm

### 4-C  FHIR mapper service

- [x] Create `apps/api/src/services/fhir/mappers.ts`
- [x] Implement pure mapping functions (no DB calls):
  - [x] `mapPatient(patient, org) → FhirPatient`
  - [x] `mapObservation(entry, loincCode) → FhirObservation`
  - [x] `mapMedicationRequest(med) → FhirMedicationRequest`
  - [x] `mapQuestionnaireResponse(assessment) → FhirQuestionnaireResponse`
  - [x] `mapCondition(diagnosis) → FhirCondition`
  - [x] `mapBundle(resources, type) → FhirBundle`
- [x] Create `apps/api/src/services/fhir/validator.ts`
  - [x] Validate outgoing FHIR resources against R4 schema
  - [x] Log validation errors (do not throw — resilience over correctness)
- [x] Install `@fhir-typescript/r4-core` for type definitions

### 4-D  FHIR API routes

- [x] Create `apps/api/src/routes/fhir/index.ts`
- [x] Implement each endpoint (see plan §8.2):
  - [x] `GET /fhir/Patient/:patientId`
  - [x] `GET /fhir/Patient/:patientId/$everything` (full Bundle)
  - [x] `GET /fhir/Observation?patient=&code=`
  - [x] `GET /fhir/MedicationRequest?patient=`
  - [x] `GET /fhir/QuestionnaireResponse?patient=`
  - [x] `GET /fhir/Condition?patient=`
  - [x] `GET /fhir/CarePlan?patient=`
  - [x] `GET /fhir/Consent?patient=`
  - [x] `GET /fhir/metadata` (CapabilityStatement — public)
- [x] All endpoints: set `Content-Type: application/fhir+json; fhirVersion=4.0`
- [x] All endpoints: FHIR bundle pagination via `Bundle.link` (`next`, `previous`)
- [x] Register in `apps/api/src/routes/index.ts`

### 4-E  CDA handover generator

- [x] Create `apps/api/src/services/cdaGenerator.ts`
- [x] Generate CDA R2 XML with these sections:
  - [x] Patient demographics
  - [x] Active problems (ICD-10)
  - [x] Active medications
  - [x] Recent assessment scores (last PHQ-9, GAD-7, ASRM)
  - [x] 30-day mood trend (text summary)
  - [x] Care team members
  - [x] Last 5 non-private clinician notes
  - [x] Crisis safety plan (if exists)
- [x] MIME type: `application/hl7-v3+xml`
- [x] Extend `POST /reports` to accept `report_type: 'cda_handover'`
- [x] Update `CreateReportSchema` in shared schemas to include `'cda_handover'`

### 4-F  Crisis safety plan endpoints

- [x] Add to appropriate route file (create `apps/api/src/routes/safety/` or add to patients):
  - [x] `GET /patients/:id/safety-plan` — clinician + patient (own)
  - [x] `PUT /patients/:id/safety-plan` — clinician only (upsert)
- [x] Register route

### 4-G  Research export routes

- [x] Create `apps/api/src/routes/research/index.ts`
- [x] `POST /research/export` (admin/researcher only)
- [x] `GET /research/export/:id` — poll status + download URL
- [x] `GET /research/cohort-count?filters=` — count matching patients
- [x] `GET /research/omop-concepts?search=` — search OMOP concept IDs
- [x] Extend `report-generator.ts` worker to handle `research_export` job type

---

## Phase 5 — Web Dashboard Clinical Intelligence

### 5-A  API — population breakdown endpoint

- [x] Read `apps/api/src/routes/clinicians/index.ts` in full
- [x] Add `GET /clinicians/population-breakdown?days=30`
  - [x] Returns `moodDistribution`, `statusBreakdown`, `assessmentCompletion`, `adherenceRate`
  - [x] Cache in Redis for 30 minutes (key by clinician org_id + days param)

### 5-B  API — global search endpoint

- [x] Add `GET /search?q=:query&types=patients,notes` to appropriate route
- [x] Patients: fuzzy name + MRN search via `pg_trgm` (`similarity()`)
- [x] Notes: full-text search via `search_vector @@ to_tsquery()`
- [x] Returns grouped results: `{ patients: [], notes: [], assessments: [] }`
- [x] Enforce care-team scope (clinicians only see their patients' notes)

### 5-C  API — assessment request push notification

- [x] Add `POST /notifications/send-assessment-request` to notifications route
  - [x] Clinician auth required
  - [x] Validates care-team membership
  - [x] Looks up patient's Expo push token from `notification_preferences`
  - [x] Sends push via Expo Push Service: "Dr. {Name} has requested a {scale} assessment"
  - [x] Patient taps → `assessments/[scale].tsx` deep link

### 5-D  Web — Trends page enhancements

- [x] Read `apps/web/src/pages/TrendsPage.tsx` in full
- [x] Add "Mood Distribution" histogram panel (Recharts `BarChart`) — `GET /clinicians/population-breakdown`
- [x] Add "Medication Adherence Rate" gauge (custom SVG arc) — same endpoint
- [x] Add "Assessment Completion Rate" stacked bar (week by week)
- [x] Add "Week-over-Week Patient Status" chart using snapshot history

### 5-E  Web — Cohort page (new)

- [x] Create `apps/web/src/pages/CohortPage.tsx`
- [x] Create `apps/web/src/components/CohortFilterRow.tsx`
- [x] Filter criteria UI: diagnosis / age range / PHQ-9 severity / GAD-7 severity / medication / tracking streak / date range
- [x] Live patient count (debounced `GET /research/cohort-count?filters=...`)
- [x] "Export Cohort" button → `POST /research/export` → polling → download NDJSON
- [x] Route: add `/cohort` to router (admin/researcher roles only)

### 5-F  Web — Global search component

- [x] Create `apps/web/src/components/GlobalSearch.tsx`
- [x] Command-palette style (overlay, triggered by `/` or CMD+K)
- [x] Debounced 200ms → `GET /search?q=...`
- [x] Grouped results list: Patients / Notes
- [x] Arrow key navigation, Enter to go to result
- [x] Register keyboard shortcut in `AppShell.tsx`

### 5-G  Web — Quick note panel

- [x] Create `apps/web/src/components/QuickNotePanel.tsx`
- [x] Slide-in panel from right edge (CSS transform animation)
- [x] Pre-filled with last-viewed patient
- [x] Note type dropdown + text area
- [x] "Save Note" → `POST /clinicians/notes/:patientId`
- [x] Trigger: keyboard shortcut `N` + button in quick-actions bar

### 5-H  Web — Assessment request modal

- [x] Create `apps/web/src/components/AssessmentRequestModal.tsx`
- [x] Scale selector (PHQ-9, GAD-7, ASRM, C-SSRS, ISI, WHODAS)
- [x] "Send Request" → `POST /notifications/send-assessment-request`
- [x] Success toast: "Assessment request sent to {patientFirstName}"

### 5-I  Web — Keyboard shortcuts

- [x] Create `apps/web/src/hooks/useKeyboardShortcuts.ts`
- [x] `N` → focus quick note panel (last-viewed patient)
- [x] `A` → navigate to Alerts page
- [x] `P` → navigate to Patients page
- [x] `/` → focus global search (prevent browser default)
- [x] `Esc` → close any open modal
- [x] `?` → open shortcuts overlay modal
- [x] Register in `AppShell.tsx` via `useKeyboardShortcuts()`

### 5-J  Web — Patient Detail enhancements

- [x] 90-day mood heatmap (extend from 30)
  - [x] Scrollable horizontal viewport
  - [x] Hover tooltip: mood, sleep, adherence, any alerts
  - [x] Click a day → jump to timeline filtered to that date
- [x] Assessment history chart (PHQ-9, GAD-7, ASRM over time)
  - [x] Reference lines at clinical cut-offs
  - [x] Inline annotation on score points
- [x] "Compare with previous period" toggle (side-by-side mood chart)
- [x] Quick actions sticky footer: "Add Note" · "Request Assessment" · "Generate Report" · "Escalate Alert"

---

## Phase 6 — Infrastructure, Testing & Compliance

### 6-A  API test helpers

- [ ] Create `apps/api/src/__tests__/helpers/testDb.ts`
  - [ ] Spin up `PostgreSqlContainer` (testcontainers)
  - [ ] Run all migrations via migration runner
  - [ ] Seed minimal test data (1 org, 1 clinician, 1 patient, 1 care_team_member)
  - [ ] Export `getTestDb()`, `cleanDb()`, `tearDown()`
- [ ] Create `apps/api/src/__tests__/helpers/testApp.ts`
  - [ ] Build Fastify app with test DB URL, mock Redis, mock Supabase
  - [ ] Export `buildTestApp()`
- [ ] Create `apps/api/src/__tests__/helpers/mockSupabase.ts`
  - [ ] `vi.mock('@supabase/supabase-js')` with auto-confirm user creation

### 6-B  API integration tests

- [ ] Create `apps/api/src/__tests__/auth.test.ts`
  - [ ] Test login (valid, wrong password, non-existent user)
  - [ ] Test MFA verify
  - [ ] Test refresh token
  - [ ] Test register (valid token, expired token, duplicate email, already-used token)
- [ ] Create `apps/api/src/__tests__/invites.test.ts`
  - [ ] Test create invite (success, duplicate, already registered)
  - [ ] Test validate token (valid, expired, used)
  - [ ] Test resend (success, max resends exceeded)
  - [ ] Test cancel
- [ ] Create `apps/api/src/__tests__/patients.test.ts`
  - [ ] Test caseload, patient detail, care team CRUD
  - [ ] Test intake PATCH (partial update, mark_complete)
- [ ] Create `apps/api/src/__tests__/daily-entries.test.ts`
  - [ ] Test create (valid, schema validation failures)
  - [ ] Test submit (triggers rules engine via spy)
- [ ] Create `apps/api/src/__tests__/alerts.test.ts`
  - [ ] Test list, acknowledge, resolve, escalate
- [ ] Create `apps/api/src/__tests__/assessments.test.ts`
  - [ ] Test submit PHQ-9, fetch pending, FHIR export
- [ ] Create `apps/api/src/__tests__/insights.test.ts`
  - [ ] Test GET /insights/me with real data in DB
  - [ ] Test AI endpoints return 503 when BAA flag not set
- [ ] Create `apps/api/src/__tests__/fhir.test.ts`
  - [ ] Test each FHIR resource endpoint returns valid FHIR R4 JSON
  - [ ] Test $everything bundle includes all resource types
  - [ ] Test metadata returns CapabilityStatement

### 6-C  Mobile component tests

- [ ] Create `apps/mobile/__tests__/screens/Today.test.tsx`
  - [ ] Renders loading state, renders mood row, renders passive health card
- [ ] Create `apps/mobile/__tests__/screens/onboarding-consent.test.tsx`
  - [ ] Screen transitions, consent API calls, continue button state
- [ ] Create `apps/mobile/__tests__/screens/onboarding-intake.test.tsx`
  - [ ] Step navigation, skip buttons, mark_complete call on step 6
- [ ] Create `apps/mobile/__tests__/components/VoiceRecorder.test.tsx`
  - [ ] Permission request, start/stop, max duration enforcement
- [ ] Create `apps/mobile/__tests__/services/healthData.test.ts`
  - [ ] Permission flow, sync to API, conflict handling

### 6-D  Web unit tests

- [ ] Create `apps/web/src/__tests__/pages/DashboardPage.test.tsx`
- [ ] Create `apps/web/src/__tests__/pages/PatientDetailPage.test.tsx`
  - [ ] All 5 tabs render, AI tab hidden when feature disabled
- [ ] Create `apps/web/src/__tests__/components/InvitePatientModal.test.tsx`
  - [ ] Success flow, 409 error handling, 429 error handling
- [ ] Create `apps/web/src/__tests__/components/GlobalSearch.test.tsx`
  - [ ] Keyboard shortcut opens it, results grouped correctly

### 6-E  Playwright E2E tests

- [x] `apps/web/e2e/` directory structure exists with auth, patients, alerts, dashboard, keyboard, navigation, admin, pages specs
- [ ] Confirm `e2e/auth.spec.ts` covers: Login → MFA → dashboard → logout
- [ ] Confirm `e2e/patient-detail.spec.ts` covers: navigate, mood heatmap, add note, request assessment
- [ ] Create `apps/web/e2e/invite-flow.spec.ts` — invite patient, verify pending badge, resend, cancel
- [ ] Create `apps/web/e2e/reports.spec.ts` — request report, poll for completion, download link appears
- [ ] Confirm `e2e/alerts.spec.ts` covers: acknowledge alert, verify removed from feed

### 6-F  CI/CD pipeline

- [x] Create `.github/workflows/ci.yml`
  - [x] Jobs: `lint`, `test-api`, `test-web`, `test-mobile`, `coverage-report`
  - [x] `test-api` uses GitHub Actions service containers for Postgres 17 + Redis 7
- [x] Create `.github/workflows/deploy.yml`
  - [x] Triggers on merge to `main`
  - [x] Deploy API (SSH + pm2 reload)
  - [x] Deploy web (build + rsync to nginx)
  - [x] EAS build trigger on tagged releases (`v1.1.*`)
- [ ] Add `CODECOV_TOKEN` to GitHub Actions secrets (get from codecov.io)

### 6-G  Sentry error monitoring

- [x] Add `@sentry/node`, `@sentry/react-native`, `@sentry/react` to respective packages
- [x] Add `SENTRY_DSN` to `.env.example`
- [x] Edit `apps/api/src/server.ts`: add `Sentry.init()` + Fastify integration
- [x] Edit `apps/mobile/app/_layout.tsx`: add `Sentry.init()` (dev client integration)
- [x] Edit `apps/web/src/main.tsx`: add `Sentry.init()`
- [x] ALL THREE: implement `beforeSend` hook stripping `email`, `name`, `phone`, `date_of_birth` from events
- [x] Set `tracesSampleRate: 0.1` for production
- [ ] Update INSTALLER.sh production flow to prompt for `SENTRY_DSN`

### 6-H  HIPAA hardening

- [x] Tighten `@fastify/rate-limit`: 30 req/15s on auth routes, 60 req/min on data routes
- [x] Audit all raw SQL in `packages/db/src/` for parameterised query usage (look for string interpolation)
- [x] Enforce `TRUSTED_PROXIES` env var in rate-limiting middleware
- [ ] Add idle timeout on web dashboard: auto-logout after 15 min inactivity (`useIdleTimer`)
- [ ] Enforce TLS 1.3 only in INSTALLER.sh nginx config (`ssl_protocols TLSv1.3`)
- [x] Add nightly job in `nightly-scheduler.ts`: purge `audit_logs` older than 7 years, `notification_logs` older than 90 days
- [ ] Add `HIPAA_ASSESSMENT_COMPLETE` check to admin-only routes (warn in server startup log if false)
- [ ] Document break-glass (emergency access) procedure in a `RUNBOOK.md`

### 6-I  Database backup

- [ ] Create `scripts/backup.sh`
  - [ ] `pg_dump | gzip | openssl enc -aes-256-cbc -pbkdf2` → `/backups/mindlog-YYYYMMDD.sql.gz.enc`
  - [ ] Retain 30 days; prune older files
  - [ ] Require `BACKUP_ENCRYPTION_KEY` env var
- [ ] Create `scripts/backup-restore-test.sh` (decrypt + restore to temp DB + spot-check)
- [ ] Add systemd timer: daily at 03:30 (add to INSTALLER.sh)
- [ ] Add `BACKUP_ENCRYPTION_KEY` to `.env.example` and INSTALLER.sh prompt

### 6-J  Performance optimisation

- [ ] Run `EXPLAIN ANALYZE` on 5 slowest queries (caseload, insights, alert filtering)
- [ ] Add missing indexes identified above
- [ ] Add Redis cache to `GET /clinicians/snapshot` (30-min TTL, invalidated on daily entry submit)
- [ ] Add `pg_stat_statements` to INSTALLER.sh PostgreSQL setup
- [ ] Audit Vite bundle with `vite-bundle-analyzer`; move large chart components to dynamic imports
- [ ] Target web initial load < 300 KB (check with `npx vite build --reporter=json`)

### 6-K  i18n groundwork (no visible UI change)

- [ ] Create `apps/mobile/i18n/en.ts` with all hardcoded user-facing strings
- [ ] Replace hardcoded strings in each screen with references to `en.ts`
- [ ] Ensure all date formatting uses `date-fns/locale`
- [ ] Ensure web uses `Intl.DateTimeFormat` consistently

---

## Cross-cutting items (can be done in any phase)

- [x] Add `GET /patients/:id/safety-plan` and `PUT /patients/:id/safety-plan` endpoints
- [ ] Add cursor-based pagination to all list endpoints that currently use offset (for future clinician mobile app)
- [ ] Add `ETag` header to `GET /clinicians/caseload` and `GET /patients/:id`
- [ ] Add `compact=true` query param to `GET /clinicians/caseload`
- [~] Update INSTALLER.sh production section:
  - [ ] Add `SENTRY_DSN` prompt
  - [ ] Add `BACKUP_ENCRYPTION_KEY` prompt and nightly backup timer
  - [ ] Add `OPENAI_API_KEY` prompt (Whisper)
  - [ ] Add PgBouncer install step (transaction mode)
- [ ] Update `README.md` version line to `1.1` (will be done automatically by docs-agent hourly)
- [ ] Update `apps/mobile/app.json` version to `1.1.0`

---

## Definition of Done (per phase)

A phase is complete when:

1. All checkboxes in that phase are ticked
2. `npx turbo run build` passes with zero errors
3. `npm run lint` passes with zero warnings
4. All new API endpoints are tested with `curl` or Postman and return expected shapes
5. The phase-specific verification checklist (where present) passes end-to-end
6. No new `console.error` or unhandled promise rejection warnings in API or mobile logs

---

*Generated from V1.1_DEVELOPMENT_PLAN.md — update both files together when scope changes.*
