# MindLog — Version 1.1 Development Plan

**Document version:** 1.0
**Date:** February 2026
**Status:** Draft — pending team review
**Builds on:** v0.2a (70+ API endpoints, 8 DB migrations, 19 mobile screens, 9 web pages)

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Current State Assessment](#2-current-state-assessment)
3. [Version 1.1 Goals](#3-version-11-goals)
4. [Phase Overview](#4-phase-overview)
5. [Phase 1 — Patient Registration & Onboarding](#5-phase-1--patient-registration--onboarding)
6. [Phase 2 — Mobile Clinical Depth](#6-phase-2--mobile-clinical-depth)
7. [Phase 3 — AI-Powered Clinical Intelligence](#7-phase-3--ai-powered-clinical-intelligence)
8. [Phase 4 — EHR Interoperability & FHIR R4](#8-phase-4--ehr-interoperability--fhir-r4)
9. [Phase 5 — Web Dashboard Clinical Intelligence](#9-phase-5--web-dashboard-clinical-intelligence)
10. [Phase 6 — Infrastructure, Testing & Compliance Hardening](#10-phase-6--infrastructure-testing--compliance-hardening)
11. [Cross-Cutting Concerns](#11-cross-cutting-concerns)
12. [New Dependencies](#12-new-dependencies)
13. [Database Migrations Summary](#13-database-migrations-summary)
14. [API Surface Changes](#14-api-surface-changes)
15. [Compliance & Regulatory Checkpoints](#15-compliance--regulatory-checkpoints)
16. [Risk Register](#16-risk-register)
17. [Success Metrics](#17-success-metrics)
18. [File Change Master List](#18-file-change-master-list)

---

## 1. Executive Summary

Version 1.1 transforms MindLog from a functioning beta with strong clinical foundations into a production-ready clinical platform suitable for a formal pilot with licensed clinicians and real patients. The six phases of v1.1 address the four key gaps that stand between the current codebase and a deployable clinical product:

1. **Incomplete onboarding** — Patients cannot yet self-register; the invite flow, consent wizard, and clinical intake wizard exist in the plan but not in production code.
2. **Passive data blindspots** — The platform relies entirely on manual check-ins; HealthKit and Google Health Connect passive data (steps, heart rate variability, sleep stages) would significantly improve signal quality without additional patient burden.
3. **Underutilised AI** — `ANTHROPIC_API_KEY` and `@anthropic-ai/sdk` are in the codebase, but AI insights are gated behind a BAA flag with no actual inference pipeline. v1.1 builds the full pipeline, ready to activate on BAA execution.
4. **EHR isolation** — No mechanism to export records into hospital EHR systems, limiting adoption in institutional settings. v1.1 adds a full FHIR R4 REST layer and a CDA handover document generator.

Beyond these four pillars, v1.1 also delivers: dark mode, voice journaling, WCAG 2.1 AA mobile accessibility, a population-level research cohort tool, a complete automated test suite, CI/CD pipeline, EAS production builds, and a HIPAA hardening audit.

**Estimated timeline:** 10–12 weeks (two engineers full-time).
**Target release:** May 2026.

---

## 2. Current State Assessment

### What is complete (v0.2a)

| Area | Status | Notes |
|------|--------|-------|
| API — Auth (login, MFA, refresh, logout) | ✅ Complete | Supabase + JWT + TOTP |
| API — Daily entries (CRUD + submit) | ✅ Complete | 16 clinical domains in schema |
| API — Journal (CRUD + share) | ✅ Complete | |
| API — Medications (CRUD + adherence logs) | ✅ Complete | |
| API — Alerts (CRUD + WebSocket broadcast) | ✅ Complete | 8 rule keys |
| API — Reports (PDF via Puppeteer) | ✅ Complete | 3 report types |
| API — Assessments (PHQ-9, GAD-7, ASRM, C-SSRS, FHIR) | ✅ Complete | |
| API — Insights (aggregated trends) | ✅ Complete | Non-AI aggregation |
| API — Sync (WatermelonDB pull/push) | ✅ Complete | |
| API — Catalogues, Consent, Notifications | ✅ Complete | |
| API — Patient invites (DB + route stubs) | ⚠️ Partial | DB migration 008 exists; API routes and email sending incomplete |
| API — AI insights pipeline | ❌ Not started | SDK present; no inference logic |
| API — FHIR R4 full record export | ⚠️ Partial | Assessment FHIR only |
| Mobile — Auth, MFA, biometric | ✅ Complete | |
| Mobile — Today screen (check-in, mood, medications) | ✅ Complete | |
| Mobile — Insights (charts, correlations) | ✅ Complete | |
| Mobile — Journal | ✅ Complete | |
| Mobile — Assessments (PHQ-9, GAD-7, ASRM, C-SSRS) | ✅ Complete | |
| Mobile — Settings (notifications, biometric, consent) | ✅ Complete | |
| Mobile — Patient onboarding (invite → registration → consent → intake) | ❌ Not started | Screens planned but not built |
| Mobile — Voice journaling (STT) | ❌ Not started | |
| Mobile — Dark mode | ❌ Not started | |
| Mobile — HealthKit / Health Connect passive data | ❌ Not started | |
| Mobile — Accessibility (WCAG 2.1 AA) | ❌ Not started | |
| Web — Dashboard, Patients, Patient Detail, Alerts, Reports, Trends | ✅ Complete | |
| Web — Invite patient modal | ⚠️ Partial | Component created; not wired to API |
| Web — Research/cohort tools | ❌ Not started | OMOP tables exist; no UI |
| Web — Population comparison charts | ❌ Not started | |
| DB — Migrations 001–008 | ✅ Complete | 25+ tables |
| DB — Migration 009+ (v1.1 additions) | ❌ Not started | |
| Workers — Rules engine, report generator, nightly scheduler | ✅ Complete | |
| Workers — AI inference worker | ❌ Not started | |
| Testing — Unit, integration, E2E | ❌ Not started | |
| CI/CD | ❌ Not started | |
| EAS production build | ❌ Not started | |

### Key metrics at v0.2a

- **API endpoints:** 70+
- **Database tables:** 25+, 8 migrations
- **Mobile screens:** 19
- **Web pages/components:** 9 pages, 4 components
- **Test coverage:** 0%
- **HIPAA BAA status:** Not executed (Anthropic, Supabase)

---

## 3. Version 1.1 Goals

### Primary goals (must ship)

1. **Complete patient onboarding** — Full invite → registration → consent → intake flow working end-to-end on mobile and web.
2. **Production mobile build** — EAS-signed APK/IPA ready for TestFlight and internal Android distribution.
3. **80% test coverage** — API integration tests, mobile component tests, web E2E tests.
4. **WCAG 2.1 AA mobile accessibility** — Screen reader support, dynamic font scaling, minimum touch targets.
5. **HealthKit & Google Health Connect** — Passive step count, HRV, and sleep stage ingestion (patient opt-in).
6. **Invite + messaging system completion** — Email sending via Resend operational end-to-end.

### Secondary goals (should ship)

7. **AI insights pipeline** — Full inference pipeline built and tested; disabled by default, activates on `ANTHROPIC_BAA_SIGNED=true`.
8. **FHIR R4 full record export** — Patient, Observation, MedicationRequest, QuestionnaireResponse bundles.
9. **Dark mode** — System-aware, respects OS preference.
10. **Voice journaling** — On-device STT via Expo Speech, Android + iOS.
11. **Cohort research tool** — Web UI for building OMOP-based patient cohorts.
12. **Population-level charts** — Week-over-week trend comparison for the clinician dashboard.

### Deferred to v1.2

- Telehealth video integration (Twilio Video / Daily.co)
- Multi-language support (i18n)
- Family/caregiver portal
- Apple Watch / Wear OS companion app
- Peer support / group sessions feature
- HL7 v2 ADT feed for hospital EHR bi-directional sync

---

## 4. Phase Overview

| Phase | Name | Weeks | Engineer |
|-------|------|-------|----------|
| 1 | Patient Registration & Onboarding | 1–2 | Full-stack |
| 2 | Mobile Clinical Depth | 2–5 | Mobile |
| 3 | AI-Powered Clinical Intelligence | 3–6 | Backend + Mobile |
| 4 | EHR Interoperability & FHIR R4 | 4–7 | Backend |
| 5 | Web Dashboard Clinical Intelligence | 5–8 | Frontend |
| 6 | Infrastructure, Testing & Compliance | 7–12 | DevOps + All |

Phases 2–5 run in parallel after Phase 1. Phase 6 runs concurrently from week 7 and finalises the release.

---

## 5. Phase 1 — Patient Registration & Onboarding

**Duration:** Weeks 1–2
**Goal:** A clinician can send an invite from the web portal; a patient taps the link, registers on mobile, completes consent and intake, and arrives on the Today screen. Every step is covered by the API, persisted to PostgreSQL, and auditable.

### 5.1 Database — Migration 009

**File:** `packages/db/migrations/009_voice_and_health_prefs.sql`

No new tables required for Phase 1 (migration 008 already contains `patient_invites` and the new `patients` columns). Migration 009 is reserved for Phase 2 additions.

Verify that all columns added in migration 008 are indexed correctly:

```sql
-- Confirm these indexes exist (add if missing)
CREATE INDEX IF NOT EXISTS idx_patient_invites_token_pending
  ON patient_invites (token) WHERE status = 'pending';

CREATE INDEX IF NOT EXISTS idx_patient_invites_clinician_status
  ON patient_invites (clinician_id, status);

CREATE INDEX IF NOT EXISTS idx_patients_invite_id
  ON patients (invite_id) WHERE invite_id IS NOT NULL;
```

### 5.2 API — Messaging Service

**File:** `apps/api/src/services/messaging.ts` (NEW)

Add the `resend` client (already in `apps/api/package.json` at v6.9.2). Implement two functions:

```typescript
sendInviteEmail(opts: {
  to: string;
  token: string;
  clinicianName: string;
  orgName: string;
  personalMessage?: string;
  expiresAt: Date;
}): Promise<void>

sendWelcomeEmail(opts: {
  to: string;
  firstName: string;
  clinicianName: string;
}): Promise<void>
```

**Invite email design:**
- Subject: `{orgName} — Your clinician has invited you to MindLog`
- Deep link CTA button: `mindlog://invite?token={token}`
- Plain-text fallback with token for copy-paste
- Crisis line footer (pulled from env vars `CRISIS_LINE_PHONE` / `CRISIS_LINE_NAME`)
- Clear expiry date (7 days from send)
- Unsubscribe note (CAN-SPAM compliance)

**Template rendering:** Use simple string interpolation (no external template engine — avoids dependencies). HTML stored as a tagged template literal in `messaging.ts`.

### 5.3 API — Invite Routes

**File:** `apps/api/src/routes/invites/index.ts` (NEW)

```
POST   /api/v1/invites                    clinician — create invite + send email
GET    /api/v1/invites                    clinician — list own invites + status
GET    /api/v1/invites/validate/:token    PUBLIC    — validate token (no auth required)
POST   /api/v1/invites/:id/resend         clinician — resend (max 3 times, 1h cooldown)
DELETE /api/v1/invites/:id               clinician — cancel pending invite
```

**Business rules:**
- `POST /invites` — reject if email already registered as a patient; reject if pending invite already sent to that email by this clinician within 7 days.
- `GET /invites/validate/:token` — returns `{ clinicianName, orgName, email, expiresAt }` on success; returns 404 with `code: INVITE_EXPIRED | INVITE_USED | INVITE_NOT_FOUND`.
- `POST /invites/:id/resend` — check `resend_count < 3`, update `resent_at`, bump `expires_at` by 7 days from now, call `sendInviteEmail()`.
- All invite mutations write to `audit_logs`.

**Register in** `apps/api/src/routes/index.ts`:

```typescript
fastify.register(inviteRoutes, { prefix: '/invites' });
```

### 5.4 API — Patient Registration Route

**File:** `apps/api/src/routes/auth.ts` (EDIT — add `POST /auth/register`)

The registration endpoint is public (no JWT required). It accepts `RegisterSchema` (defined in `packages/shared/src/schemas/index.ts`) and runs the following transaction atomically:

```
1. Validate RegisterSchema (invite_token, email, password ≥12 chars, first_name, last_name, date_of_birth, timezone)
2. SELECT patient_invites WHERE token = :token AND status = 'pending' AND expires_at > NOW()
   → 400 INVITE_EXPIRED if not found
3. SELECT 1 FROM patients WHERE email = :email → 409 CONFLICT if exists
4. supabase.auth.admin.createUser({ email, password, email_confirm: true })
5. INSERT INTO patients (id = gen_random_uuid(), NOT the Supabase auth UUID)
6. UPDATE patient_invites SET status='accepted', patient_id=..., accepted_at=NOW()
7. INSERT INTO care_team_members (patient_id, clinician_id from invite, role='primary')
8. INSERT INTO consent_records × 2 (terms_of_service, privacy_policy, granted=TRUE)
9. INSERT INTO audit_logs
10. sendWelcomeEmail()
11. rulesQueue.add('patient_registered', { clinicianId, patientId })
12. Return { access_token, refresh_token, user }  ← same shape as /auth/login
```

**IMPORTANT:** `patients.id` is a new UUID, never the Supabase auth UUID. The Supabase auth UUID is stored in `patients.supabase_uid` (new column — add to migration 009 if not already present from migration 008).

### 5.5 API — Patient Intake Route

**File:** `apps/api/src/routes/patients/me.ts` (EDIT — add `PATCH /patients/me/intake`)

Accepts `IntakeSchema`:

```typescript
z.object({
  primary_concern:                z.string().max(500).optional(),
  emergency_contact_name:         z.string().max(200).optional(),
  emergency_contact_phone:        z.string().max(30).optional(),
  emergency_contact_relationship: z.string().max(100).optional(),
  mark_complete:                  z.boolean().optional(),
})
```

Updates matching columns. If `mark_complete: true`, sets `patients.intake_complete = TRUE`. Writes to `audit_logs`.

### 5.6 Mobile — Deep Link Wiring

**File:** `apps/mobile/app.json` (EDIT)

Add Android intent filters and iOS URL scheme to the Expo config:

```json
{
  "expo": {
    "scheme": "mindlog",
    "android": {
      "intentFilters": [
        {
          "action": "VIEW",
          "data": [{ "scheme": "mindlog", "host": "invite" }],
          "category": ["BROWSABLE", "DEFAULT"]
        }
      ]
    }
  }
}
```

**File:** `apps/mobile/app/_layout.tsx` (EDIT)

Add deep link handler on mount using `expo-linking`:

```typescript
useEffect(() => {
  const handleUrl = (url: string) => {
    const parsed = Linking.parse(url);
    if (parsed.hostname === 'invite' && parsed.queryParams?.token) {
      router.replace(`/onboarding?token=${parsed.queryParams.token}`);
    }
  };
  Linking.getInitialURL().then(url => { if (url) handleUrl(url); });
  const sub = Linking.addEventListener('url', ({ url }) => handleUrl(url));
  return () => sub.remove();
}, []);
```

Extend the navigation guard `useEffect` to detect `intake_complete = false` on login and redirect to `/onboarding-consent`:

```typescript
if (ready && isAuthenticated && session?.role === 'patient' && !intakeComplete) {
  router.replace('/onboarding-consent');
}
```

**File:** `apps/mobile/services/auth.ts` (EDIT)

Add `INTAKE_COMPLETE` to `KEYS`. Store `intake_complete` in `storeSession()`. Expose `getIntakeComplete(): Promise<boolean>`.

### 5.7 Mobile — Registration Tab in Onboarding

**File:** `apps/mobile/app/onboarding.tsx` (EDIT)

Add a two-tab toggle at the top: **Sign In** | **Create Account**.

**Create Account tab fields:**
1. **Invite Code** — text input, auto-filled from `useLocalSearchParams().token`. Validates on blur: `GET /invites/validate/:token`. Shows green "✓ Invited by Dr. {Name}" or red error.
2. **First Name** + **Last Name** — side by side in a row.
3. **Date of Birth** — `DD / MM / YYYY` format with basic parsing and age ≥ 18 validation.
4. **Email** — pre-filled from invite validate response; editable.
5. **Password** — min 12 characters. Inline password strength bar using character class checks (red < 3 classes, yellow = 3, green = 4+).
6. **Confirm Password** — must match.
7. **Create Account** CTA — `POST /auth/register` → on success `storeSession()` → `router.replace('/onboarding-consent')`.

Error handling: network errors show a dismissable banner at the top of the form. Field-level validation errors highlight the field border in red with an inline message below.

### 5.8 Mobile — Consent Wizard

**File:** `apps/mobile/app/onboarding-consent.tsx` (NEW)

Three sequential screens using `Animated.timing` slide transitions (200ms, same pattern as `checkin.tsx`). Uses `LinearGradient`, `DESIGN_TOKENS`, and the existing `apiFetch` helper.

**Screen 1 — Welcome**
- `LinearGradient` header: `#1a1f35` → `#161a27` (same as Today screen).
- "Welcome, {firstName}!" retrieved via `getStoredUser()`.
- Brief paragraph explaining that Dr. {clinicianName} has invited them and what to expect.
- "Get Started →" button.

**Screen 2 — Required Consents**
- Terms of Service — scrollable card with full text. **"I Agree"** button → `POST /consent { consent_type: 'terms_of_service', granted: true }`.
- Privacy Policy / HIPAA Notice — scrollable card. **"I Agree"** button → `POST /consent { consent_type: 'privacy_policy', granted: true }`.
- "Continue" button only enabled once both are agreed.
- "Both are required to use MindLog" caption.

**Screen 3 — Optional Consents**
- Toggle: **Research Data Use** (description: "Anonymised data may be used to improve mental health care research") → `POST /consent { consent_type: 'data_research', granted: true/false }`.
- Toggle: **AI Insights** — only rendered if `EXPO_PUBLIC_AI_INSIGHTS_ENABLED=true` → `POST /consent { consent_type: 'ai_insights', granted: true/false }`.
- "Continue →" → `router.replace('/onboarding-intake')`.

### 5.9 Mobile — Clinical Intake Wizard

**File:** `apps/mobile/app/onboarding-intake.tsx` (NEW)

Seven-step wizard. Segmented progress bar (one segment per step, same visual pattern as `checkin.tsx`). Back button visible from step 2 onward. Steps 2–5 have a "Skip for now" link. Step 6 is not skippable.

**Step 1 — Primary Concern** _(required)_
- "What brings you to care?" heading.
- 2-column card grid: Depression / Low Mood · Anxiety · Bipolar Disorder · PTSD / Trauma · ADHD · Sleep Problems · Other.
- "Other" reveals a text input.
- On select: `PATCH /patients/me/intake { primary_concern }`.

**Step 2 — Current Medications** _(skippable)_
- Debounced search field (300ms) → `GET /catalogues/medications?search=`.
- Tap result to add. Dose + frequency fields appear inline.
- Selected medications shown as removable chips at top.
- "Skip — I'm not taking any medications" link at bottom.
- On confirm: `POST /medications` for each added item.

**Step 3 — Symptoms You Experience** _(skippable)_
- Multi-select chip grid from `GET /catalogues/symptoms` (filter: `is_safety_symptom = FALSE`).
- Subtitle: "We'll track these in your daily check-in."
- On select/deselect: `POST /patients/me/symptoms`.

**Step 4 — Things That Affect Your Mood** _(skippable)_
- Multi-select chip grid from `GET /catalogues/triggers`.
- Subtitle: "Understanding your triggers helps personalise your care."
- On select/deselect: `POST /patients/me/triggers`.

**Step 5 — Emergency Contact** _(skippable, "Add Later" button)_
- Fields: Name, Phone (with country-code prefix), Relationship (dropdown: Partner · Parent · Sibling · Friend · Therapist · Other).
- Helper text: "Only shared with your care team if there is a safety concern."
- On save: `PATCH /patients/me/intake { emergency_contact_name, emergency_contact_phone, emergency_contact_relationship }`.

**Step 6 — Daily Reminders** _(not skippable)_
- Time picker for daily check-in notification (default: 20:00).
- Toggle: medication reminders (only shown if medications were added in Step 2).
- "Enable Notifications" button triggers OS push permission dialog. If already granted, button shows "Notifications Enabled ✓".
- On confirm: `POST /notifications/prefs` then `PATCH /patients/me/intake { mark_complete: true }`.

**Step 7 — You're All Set!**
- Spring-animated checkmark using `Animated.spring` (reuse pattern from quick-mood buttons in Today screen).
- "You're ready, {firstName}!"
- "Start My First Check-in" → `router.replace('/(tabs)')` then `router.push('/checkin')`.
- "Explore the app first" → `router.replace('/(tabs)')`.

### 5.10 Web — Invite Patient Modal (complete wiring)

**File:** `apps/web/src/components/InvitePatientModal.tsx` (EDIT — complete wiring)

The component exists but is not wired to the API. Add:
- `useMutation` (TanStack Query) calling `POST /api/v1/invites`.
- Form validation (email required, personal message max 500 chars with live counter).
- Success state: toast notification "Invite sent to {email}"; close modal; invalidate `invites` query.
- Error states: email already registered (409), duplicate pending invite (409), rate limit (429).

**File:** `apps/web/src/pages/PatientsPage.tsx` (EDIT)

- Wire "Invite Patient" button to open `InvitePatientModal`.
- Fetch `GET /invites` alongside patient list to show pending invitees.
- Pending invitees show **⏳ Pending** badge in status column.
- Clicking pending badge opens action popover: "Resend" (`POST /invites/:id/resend`) · "Cancel" (`DELETE /invites/:id`).
- On resend: toast "Invite resent to {email}". On cancel: toast "Invite cancelled" + remove from list.

**File:** `apps/web/src/pages/PatientDetailPage.tsx` (EDIT)

- In Overview tab: add "Invite Status" card, shown only if `patient.invite_id` is set.
  - `status = 'pending'`: sent date, expiry, "Resend Invite" button.
  - `status = 'accepted'`: accepted date + green "Registered" badge.
  - `status = 'expired'`: red "Expired" badge + "Resend Invite" button.

### 5.11 Shared Schemas

**File:** `packages/shared/src/schemas/index.ts` (EDIT)

Add:

```typescript
export const CreateInviteSchema = z.object({
  email:            z.string().email(),
  personal_message: z.string().max(500).optional(),
});

export const RegisterSchema = z.object({
  invite_token:  z.string().min(1),
  email:         z.string().email(),
  password:      z.string().min(12).max(128),
  first_name:    z.string().min(1).max(100),
  last_name:     z.string().min(1).max(100),
  date_of_birth: IsoDateSchema,
  timezone:      z.string().default('America/New_York'),
});

export const IntakeSchema = z.object({
  primary_concern:                z.string().max(500).optional(),
  emergency_contact_name:         z.string().max(200).optional(),
  emergency_contact_phone:        z.string().max(30).optional(),
  emergency_contact_relationship: z.string().max(100).optional(),
  mark_complete:                  z.boolean().optional(),
});
```

### 5.12 Phase 1 Verification Checklist

- [ ] `POST /invites` → row in `patient_invites`, email received in Resend dashboard
- [ ] `GET /invites/validate/:token` → returns clinician name and org name
- [ ] Expired token → 404 with `INVITE_EXPIRED`
- [ ] `POST /auth/register` with valid token → `access_token` returned
- [ ] `patients` row, `care_team_members` row, 2× `consent_records` all created
- [ ] Second `POST /auth/register` with same token → 409
- [ ] Android deep link: `adb shell am start -a android.intent.action.VIEW -d "mindlog://invite?token=XXX"` → onboarding opens with token pre-filled
- [ ] Complete onboarding → today tab visible with personalised greeting
- [ ] Fresh login with `intake_complete = FALSE` → redirected to consent wizard
- [ ] Clinician web portal: "Invite Patient" → patient shows "⏳ Pending" in list
- [ ] End-to-end: clinician sends invite → patient registers → clinician sees patient active on dashboard

---

## 6. Phase 2 — Mobile Clinical Depth

**Duration:** Weeks 2–5
**Goal:** Complete all remaining mobile app capabilities: voice journaling, passive health data, dark mode, and WCAG 2.1 AA accessibility. Produce signed EAS builds.

### 6.1 Voice Journaling — On-Device STT

**New dependency:** `expo-speech` (already in Expo SDK) for synthesis; `@react-native-voice/voice` for recognition. However, `@react-native-voice/voice` is a bare workflow dependency. Since MindLog uses Expo managed workflow, use the Web Speech API via `expo-web-browser` or switch to **Whisper API** (Anthropic / OpenAI) for transcription of recorded audio clips.

**Recommended approach:** Record audio with `expo-av` (already in Expo SDK indirectly) → upload to API → API transcribes with Whisper → returns transcript → pre-fills journal body. This avoids a bare workflow migration.

**Files changed:**

| File | Change |
|------|--------|
| `apps/mobile/app/(tabs)/journal.tsx` | Add microphone button to new-entry prompt card |
| `apps/mobile/components/VoiceRecorder.tsx` | NEW — animated waveform UI, start/stop controls, 5-min max, real-time amplitude meter |
| `apps/api/src/routes/voice/index.ts` | NEW — `POST /voice/transcribe` (multipart audio → Whisper API → transcript string) |
| `apps/api/src/routes/index.ts` | Register `/voice` route |
| `.env.example` | Add `OPENAI_API_KEY` (Whisper) |

**API: `POST /api/v1/voice/transcribe`**
- Auth: Patient JWT required.
- Accepts: `multipart/form-data` with `audio` field (m4a, mp3, wav; max 25 MB).
- Calls OpenAI Whisper API: `POST https://api.openai.com/v1/audio/transcriptions`.
- Returns: `{ transcript: string, duration_seconds: number }`.
- Rate limit: 5 transcriptions per hour per patient (Redis counter).
- Audit: writes to `audit_logs` with `action: 'voice_transcription'`, no transcript content stored.

**Mobile VoiceRecorder component:**
- Animated red dot when recording (500ms pulse using `Animated.loop + Animated.sequence`).
- Amplitude meter: 20 vertical bars using `expo-av` `onAudioSampleReceived`.
- Max recording duration: 5 minutes (enforced with a countdown timer shown at 4:30).
- "Send for transcription" button → `POST /voice/transcribe` → inserts transcript into journal text area.
- User can edit transcript before saving.
- Microphone permission requested on first tap via `expo-av Audio.requestPermissionsAsync()`.

### 6.2 HealthKit & Google Health Connect Integration

**New dependencies:**
- `react-native-health` (HealthKit, iOS)
- `react-native-health-connect` (Health Connect, Android API 35 target)

Both require bare workflow config plugins. Use `expo-build-properties` and the respective plugins in `app.json`.

**Files changed:**

| File | Change |
|------|--------|
| `apps/mobile/app.json` | Add `react-native-health` iOS entitlement plugin; add `react-native-health-connect` plugin |
| `apps/mobile/services/healthData.ts` | NEW — permission request, daily data fetch, sync to API |
| `apps/api/src/routes/health-data/index.ts` | NEW — `POST /health-data/sync` (batch write passive data) |
| `packages/db/migrations/009_passive_health.sql` | NEW — `passive_health_snapshots` table |
| `apps/mobile/app/(tabs)/index.tsx` | Show passive health data in Today summary card |

**Migration 009: `passive_health_snapshots`**

```sql
CREATE TABLE passive_health_snapshots (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  patient_id      UUID NOT NULL REFERENCES patients(id),
  snapshot_date   DATE NOT NULL,
  source          TEXT NOT NULL CHECK (source IN ('healthkit', 'health_connect', 'manual')),
  step_count      INTEGER,
  active_calories INTEGER,
  resting_hr      SMALLINT,             -- bpm
  hrv_ms          NUMERIC(6,2),         -- RMSSD in ms
  sleep_hours     NUMERIC(4,2),         -- total sleep
  sleep_deep_pct  NUMERIC(5,2),         -- % deep sleep
  sleep_rem_pct   NUMERIC(5,2),         -- % REM
  o2_saturation   NUMERIC(4,1),         -- SpO2 %
  created_at      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE (patient_id, snapshot_date, source)
);
CREATE INDEX ON passive_health_snapshots (patient_id, snapshot_date DESC);
```

**Permission flow:**
- HealthKit / Health Connect permissions requested on first entry to the Today tab after `intake_complete = TRUE`.
- Permission dialog explains: "MindLog reads step count, heart rate, and sleep data to enrich your daily report. This data stays on your device and server — it is never sold."
- User can decline; the app functions fully without passive data.
- Permissions stored in SecureStore; re-requested once every 30 days if previously declined.

**Daily sync:**
- `healthData.ts` runs on app foreground (`AppState.addEventListener('change')`).
- Fetches yesterday's and today's data from HealthKit/Health Connect.
- `POST /health-data/sync` with array of daily snapshots.
- Deduplicates on the server via `ON CONFLICT (patient_id, snapshot_date, source) DO UPDATE`.

**Insights integration:**
- `GET /insights/me` updated to include passive health fields in the correlation engine.
- New correlation: step count vs mood (7-day Pearson r).
- New correlation: sleep hours vs next-day mood.

### 6.3 Dark Mode

**Files changed:**

| File | Change |
|------|--------|
| `apps/mobile/constants/DesignTokens.ts` | Add dark-mode token overrides |
| `apps/mobile/hooks/useColorScheme.ts` | NEW — wraps `useColorScheme` from RN; respects system AND user override |
| `apps/mobile/services/auth.ts` | Add `COLOR_SCHEME_OVERRIDE` key to SecureStore |
| `apps/mobile/app/settings/index.tsx` | Add appearance toggle: System / Light / Dark |
| All screen files | Replace hardcoded colors with `useTheme()` hook |

**Dark mode color palette:**

```typescript
// DesignTokens.ts additions
export const DARK_TOKENS = {
  COLOR_BG:               '#0d1117',
  COLOR_SURFACE:          '#161b22',
  COLOR_SURFACE_ELEVATED: '#21262d',
  COLOR_BORDER:           '#30363d',
  COLOR_TEXT_PRIMARY:     '#e6edf3',
  COLOR_TEXT_SECONDARY:   '#8b949e',
  COLOR_TEXT_MUTED:       '#6e7681',
  // Accent colors remain identical (teal, amber, red maintain AA contrast on dark bg)
};
```

**`useTheme()` hook** — returns `{ colors, isDark }` based on system + user override. Used in every screen to replace `DesignTokens.COLOR_*` direct references.

### 6.4 Accessibility — WCAG 2.1 AA

**Target:** WCAG 2.1 Level AA (§1.1.1, §1.3.1, §1.4.3, §1.4.4, §1.4.10, §2.4.7, §4.1.2)

**Mobile changes:**

| WCAG Criterion | Requirement | Implementation |
|---|---|---|
| 1.1.1 Non-text content | All images have alt text | `accessibilityLabel` on all `Image` and icon components |
| 1.4.3 Contrast minimum | 4.5:1 for normal text | Audit all text colors against backgrounds; fix any failures |
| 1.4.4 Resize text | Text scales up to 200% without loss of content | Use `useWindowDimensions().fontScale`; no hard-coded font sizes in a way that clips |
| 2.4.7 Focus visible | Keyboard focus indicator | `accessible={true}` + `accessibilityRole` on all interactive elements |
| 4.1.2 Name, Role, Value | Screen reader can describe all controls | `accessibilityLabel`, `accessibilityRole`, `accessibilityState` on all custom components |
| Touch target | Min 44×44 pt | All buttons, toggles, and chips meet minimum — enforce in `Card.tsx`, `SkeletonCard.tsx` |

**New file:** `apps/mobile/utils/a11y.ts` — shared helper that generates consistent `accessibilityLabel` strings for mood scores, date ranges, and medication names.

**Audit tool:** `@testing-library/react-native` accessibility tree snapshots in test suite (Phase 6).

### 6.5 EAS Production Build Configuration

**File:** `apps/mobile/eas.json` (EDIT — currently exists as stub)

```json
{
  "cli": { "version": ">= 14.0.0" },
  "build": {
    "development": {
      "developmentClient": true,
      "distribution": "internal",
      "ios": { "simulator": true }
    },
    "preview": {
      "distribution": "internal",
      "android": { "buildType": "apk" },
      "ios": { "simulator": false }
    },
    "production": {
      "distribution": "store",
      "android": { "buildType": "aab" }
    }
  },
  "submit": {
    "production": {
      "android": { "serviceAccountKeyPath": "secrets/google-play-key.json", "track": "internal" },
      "ios": { "appleId": "APPLE_ID", "ascAppId": "APP_STORE_CONNECT_APP_ID", "appleTeamId": "TEAM_ID" }
    }
  }
}
```

**EAS secrets to configure** (not in repo):

```
EXPO_PUBLIC_API_BASE          = https://app.mindlog.health
EXPO_PUBLIC_AI_INSIGHTS_ENABLED = false
SENTRY_DSN                    = (Phase 6)
```

**Build script** in root `package.json`:

```json
"build:mobile:preview":    "eas build --profile preview --platform all",
"build:mobile:production": "eas build --profile production --platform all",
"submit:mobile":           "eas submit --profile production --platform all"
```

---

## 7. Phase 3 — AI-Powered Clinical Intelligence

**Duration:** Weeks 3–6 (parallel with Phase 2)
**Prerequisite:** `ANTHROPIC_BAA_SIGNED=true` must be set in `.env` before any patient data is sent to Anthropic. The feature gate is enforced in middleware.
**Goal:** Build a complete AI inference pipeline that generates personalised clinical insight summaries, anomaly alerts, and predictive risk indicators — all disabled by default, activatable with a single env var.

### 7.1 AI Feature Gate Middleware

**File:** `apps/api/src/middleware/aiGate.ts` (NEW)

```typescript
export function requireAiEnabled(fastify: FastifyInstance) {
  return async (request: FastifyRequest, reply: FastifyReply) => {
    if (process.env.AI_INSIGHTS_ENABLED !== 'true') {
      return reply.code(503).send({ error: 'AI insights not enabled on this server.' });
    }
    if (process.env.ANTHROPIC_BAA_SIGNED !== 'true') {
      return reply.code(503).send({ error: 'Anthropic BAA required before AI features can be enabled.' });
    }
  };
}
```

Every AI-related endpoint registers this pre-handler. Patient data never leaves the server toward Anthropic unless both flags are `true`.

### 7.2 AI Inference Worker

**File:** `apps/api/src/workers/ai-insights-worker.ts` (NEW)

**Queue name:** `mindlog-ai-insights`

**Job types:**

| Job | Trigger | Input | Output |
|-----|---------|-------|--------|
| `generate_weekly_summary` | Nightly scheduler (Sunday 03:00) | `patientId`, `weekOf` | Writes `patient_ai_insights` row |
| `generate_trend_narrative` | After daily entry submit | `patientId`, `entryId` | Appended to today's insight row |
| `detect_anomaly` | After daily entry submit | `patientId`, `entryId`, last 30 entries | If anomaly: creates `clinical_alert` with `alert_type='ai_anomaly'` |
| `risk_stratification` | Nightly (all active patients) | `patientId`, last 14 entries + assessments | Updates `patients.risk_level` with reason |

**Prompt engineering guidelines:**
- All prompts include a HIPAA preamble: "You are a clinical decision support system. Never produce definitive diagnoses. Always recommend clinical judgment."
- Temperature: `0.3` for clinical narratives (low variance), `0.0` for anomaly detection (deterministic).
- Model: `claude-sonnet-4-6` (per existing config).
- Max tokens: 800 for summaries, 200 for anomaly labels.
- Input data sanitised: no email, no name (referred to as "the patient"), no MRN — only de-identified clinical values.

### 7.3 Database — Migration 010: AI Insights Tables

**File:** `packages/db/migrations/010_ai_insights.sql` (NEW)

```sql
CREATE TABLE patient_ai_insights (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  patient_id      UUID NOT NULL REFERENCES patients(id),
  insight_type    TEXT NOT NULL CHECK (insight_type IN (
                    'weekly_summary', 'trend_narrative', 'anomaly_detection', 'risk_stratification'
                  )),
  week_of         DATE,                      -- for weekly_summary
  daily_entry_id  UUID REFERENCES daily_entries(id),
  model_id        TEXT NOT NULL,             -- e.g. 'claude-sonnet-4-6'
  prompt_tokens   INTEGER,
  completion_tokens INTEGER,
  narrative       TEXT NOT NULL,             -- the generated text
  key_findings    JSONB,                     -- structured { finding: string, severity: string }[]
  risk_delta      SMALLINT,                  -- -2 to +2 change in risk level
  consent_given   BOOLEAN NOT NULL DEFAULT FALSE,
  generated_at    TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT ai_insights_consent_check CHECK (consent_given = TRUE)
);
CREATE INDEX ON patient_ai_insights (patient_id, generated_at DESC);
CREATE INDEX ON patient_ai_insights (patient_id, insight_type, week_of);

-- Track AI inference costs per patient per month
CREATE TABLE ai_usage_log (
  id           UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  patient_id   UUID NOT NULL REFERENCES patients(id),
  month        DATE NOT NULL,              -- first day of month
  prompt_tokens_total   INTEGER NOT NULL DEFAULT 0,
  completion_tokens_total INTEGER NOT NULL DEFAULT 0,
  inference_count INTEGER NOT NULL DEFAULT 0,
  updated_at   TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE (patient_id, month)
);
```

**Consent gate in worker:** Before any inference, the worker checks `SELECT consent_given FROM consent_records WHERE patient_id = ? AND consent_type = 'ai_insights' AND granted = TRUE`. If not found, job is skipped with a `warn` log — no error, no alert.

### 7.4 API — AI Insights Endpoints

**File:** `apps/api/src/routes/insights/index.ts` (EDIT — add AI endpoints)

```
GET  /api/v1/insights/me/ai?type=weekly_summary  Patient + aiGate   Latest AI summary for patient
GET  /api/v1/insights/me/ai/history              Patient + aiGate   Last 12 weekly summaries
POST /api/v1/insights/:patientId/ai/trigger      Clinician + aiGate Force-generate a new summary (on-demand)
GET  /api/v1/insights/:patientId/ai              Clinician + aiGate Clinician-facing AI risk narrative
```

**Clinician-facing AI narrative endpoint** returns:
```json
{
  "patientId": "...",
  "generatedAt": "2026-02-22T03:00:00Z",
  "narrative": "Over the past 7 days, this patient has shown...",
  "keyFindings": [
    { "finding": "Consistent mood drop on Thursdays", "severity": "moderate" },
    { "finding": "Sleep efficiency below 70% for 5 consecutive nights", "severity": "moderate" }
  ],
  "riskDelta": -1,
  "disclaimer": "This is a clinical decision support tool. Always apply clinical judgment."
}
```

### 7.5 Mobile — AI Insights Screen

**File:** `apps/mobile/app/(tabs)/insights.tsx` (EDIT — add AI insights section)

Conditionally rendered section at the bottom of the Insights tab, only if:
- `EXPO_PUBLIC_AI_INSIGHTS_ENABLED=true`
- Patient has granted `ai_insights` consent

**UI components:**
- "AI Weekly Summary" card — gradient header (teal-to-navy), narrative text in serif Fraunces font at 16px.
- "Key Findings" list — each finding shown as a pill (red = high, amber = moderate, teal = low).
- "Generated {time} ago" caption.
- Tap to expand full narrative in a bottom sheet (`@gorhom/bottom-sheet` or custom implementation using `Animated`).

### 7.6 Web — AI Risk Narrative Panel

**File:** `apps/web/src/pages/PatientDetailPage.tsx` (EDIT)

New "AI Insights" tab (5th tab, after Overview, Timeline, Assessments, Notes):
- Weekly narrative card with risk delta badge (↑ / → / ↓).
- Key findings list.
- Historical weekly summaries (accordion, last 12 weeks).
- "Request new analysis" button → `POST /insights/:patientId/ai/trigger`.
- HIPAA disclaimer footer.
- Entire tab hidden if `AI_INSIGHTS_ENABLED !== 'true'` in server response.

### 7.7 Predictive Risk Scoring

**File:** `apps/api/src/services/riskScoring.ts` (NEW)

A rule-based (non-AI) composite risk score calculated in real-time, complementing the AI narrative:

```typescript
interface RiskScore {
  score: number;          // 0–100
  band: 'low' | 'moderate' | 'elevated' | 'high' | 'crisis';
  factors: RiskFactor[];
  calculatedAt: Date;
}

interface RiskFactor {
  key: string;            // e.g. 'suicidal_ideation_present'
  weight: number;         // contribution to score
  value: string;          // human-readable observation
}
```

**Scoring factors** (weights sum to 100 at max risk):

| Factor | Max Weight | Trigger |
|--------|-----------|---------|
| C-SSRS suicidal ideation ≥ 2 | 35 | `suicidal_ideation >= 2` in last 3 entries |
| PHQ-9 total ≥ 20 (severe) | 20 | Latest assessment |
| Mood ≤ 3 for 3+ consecutive days | 15 | Rolling window |
| Missed check-ins ≥ 5 consecutive | 10 | Nightly scheduler |
| ASRM ≥ 6 (probable mania) | 10 | Latest assessment |
| Medication non-adherence ≥ 3 days | 5 | Adherence log |
| Social avoidance + anhedonia co-occurring | 5 | Daily entry fields |

Score calculated on each daily entry submit and stored in `patients.risk_score` (new column — migration 011). Used to sort the clinician caseload and prioritise WebSocket alerts.

---

## 8. Phase 4 — EHR Interoperability & FHIR R4

**Duration:** Weeks 4–7
**Goal:** Produce a standards-compliant FHIR R4 REST API layer that allows hospital EHR systems to query MindLog patient data, and a CDA handover document for paper/email discharge summaries.

### 8.1 FHIR R4 Resource Mapping

| FHIR Resource | MindLog Source | Notes |
|---------------|----------------|-------|
| `Patient` | `patients` table | Name, DOB, gender, MRN as identifier |
| `Practitioner` | `clinicians` table | Name, role, org |
| `Organization` | `organisations` table | Name, type |
| `Observation` — Mood | `daily_entries.mood` | LOINC 72514-3 |
| `Observation` — Sleep | `daily_entries.sleep_hours` | LOINC 93832-4 |
| `Observation` — PHQ-9 | `patient_assessments` | LOINC 44261-6 |
| `Observation` — GAD-7 | `patient_assessments` | LOINC 69737-5 |
| `MedicationRequest` | `patient_medications` | RxNorm codes from `rxnorm_codes` table |
| `QuestionnaireResponse` | `patient_assessments` | Full item responses as FHIR QuestionnaireResponse |
| `Condition` | `patient_diagnoses` | ICD-10 codes via OMOP mapping |
| `CarePlan` | `care_team_members` | Care team as a FHIR CarePlan with participants |
| `Consent` | `consent_records` | FHIR Consent resource |
| `AuditEvent` | `audit_logs` | FHIR AuditEvent (last 90 days) |
| `Bundle` | Composite | Transaction bundles for patient-level export |

### 8.2 FHIR API Routes

**File:** `apps/api/src/routes/fhir/index.ts` (NEW)

All routes under `/api/v1/fhir/`. Auth: requires clinician JWT + care team membership (or patient JWT for own data).

```
GET  /fhir/Patient/:patientId                     → FHIR Patient resource
GET  /fhir/Patient/:patientId/$everything         → Full FHIR Bundle (all resources)
GET  /fhir/Observation?patient=:id&code=LOINC     → Paginated Observation list
GET  /fhir/Observation/:id                         → Single Observation
GET  /fhir/MedicationRequest?patient=:id          → MedicationRequest list
GET  /fhir/QuestionnaireResponse?patient=:id      → Assessment QuestionnaireResponses
GET  /fhir/Condition?patient=:id                  → Diagnoses as FHIR Conditions
GET  /fhir/CarePlan?patient=:id                   → Care team as CarePlan
GET  /fhir/Consent?patient=:id                    → Consent records
GET  /fhir/metadata                               → CapabilityStatement (public)
```

**Capability statement** (`GET /fhir/metadata`) — returns a FHIR R4 `CapabilityStatement` resource declaring the server's supported resources, operations, and search parameters. Required by EHR systems for auto-discovery.

**Response headers:**
```
Content-Type: application/fhir+json; fhirVersion=4.0
X-FHIR-Server: MindLog/1.1
```

**Pagination:** FHIR bundle links (`Bundle.link`) with `next` and `previous` for large result sets (page size: 50).

### 8.3 FHIR Service Layer

**File:** `apps/api/src/services/fhir/mappers.ts` (NEW)

Pure mapping functions, no DB calls. Takes a MindLog domain object and returns the FHIR equivalent.

```typescript
mapPatient(patient: PatientRow, org: OrgRow): FhirPatient
mapObservation(entry: DailyEntryRow, code: LoincCode): FhirObservation
mapMedicationRequest(med: MedicationRow): FhirMedicationRequest
mapQuestionnaireResponse(assessment: AssessmentRow): FhirQuestionnaireResponse
mapCondition(diagnosis: DiagnosisRow): FhirCondition
mapBundle(resources: FhirResource[], type: BundleType): FhirBundle
```

**File:** `apps/api/src/services/fhir/validator.ts` (NEW)

Validates outgoing FHIR resources against the R4 JSON schema using `@fhir-typescript/r4-core` (or schema-based validation with Zod). Logs validation errors without failing the request (to avoid breaking EHR integrations on minor non-conformances).

### 8.4 CDA Handover Document

**File:** `apps/api/src/services/cdaGenerator.ts` (NEW)

Generates a Clinical Document Architecture (CDA) R2 handover document as XML. Used for:
- Discharge summaries
- Cross-provider referral letters
- Paper handover documentation

**Sections included:**
1. Patient demographics
2. Active problems (ICD-10 diagnoses)
3. Active medications
4. Recent assessment scores (last PHQ-9, GAD-7, ASRM)
5. 30-day mood trend (text summary, not chart)
6. Care team members
7. Clinician notes (last 5, non-private only)
8. Crisis safety plan (if documented)

**Endpoint:** `POST /api/v1/reports` extended with `report_type: 'cda_handover'` → existing report generator queue. Returns CDA XML as a downloadable file (MIME type `application/hl7-v3+xml`).

### 8.5 Bulk Export for Research

**File:** `apps/api/src/routes/research/index.ts` (NEW — admin only)

```
POST /api/v1/research/export          Admin — request bulk de-identified export
GET  /api/v1/research/export/:id      Admin — check export status + download URL
```

**Export format:** NDJSON (Newline-Delimited JSON) — the standard format for FHIR bulk data export (SMART on FHIR Bulk Data Access spec). One line per FHIR resource.

**De-identification:** Applies Safe Harbour method (45 CFR §164.514(b)):
- Replaces all 18 PHI identifiers with synthetic surrogates
- Dates shifted by random ±30 days per patient (consistent within patient, different across patients)
- Geographic data suppressed to state level
- Age > 89 suppressed

**Database:** New `research_exports` table (migration 012). Exports enqueued via BullMQ → `report-generator.ts` extended to handle `research_export` job type.

---

## 9. Phase 5 — Web Dashboard Clinical Intelligence

**Duration:** Weeks 5–8
**Goal:** Elevate the web dashboard from a monitoring tool to an active clinical decision support interface. Add cohort tools, advanced charts, productivity features, and the research export UI.

### 9.1 Population-Level Analytics

**File:** `apps/web/src/pages/TrendsPage.tsx` (EDIT)

Add four new chart panels below the existing snapshot history chart:

| Panel | Data Source | Chart Type |
|-------|-------------|------------|
| Mood Distribution (7d) | `population_snapshots` — histogram of mood scores | Histogram (Recharts BarChart) |
| Medication Adherence Rate | `/clinicians/snapshot` | Gauge (custom SVG arc) |
| Assessment Completion Rate | `/clinicians/snapshot` | Stacked bar (week by week) |
| Week-over-Week Patient Status | `/clinicians/snapshot-history` | Sankey diagram (D3, via recharts Sankey or custom) |

**New API endpoint required:**

`GET /api/v1/clinicians/population-breakdown?days=30` — returns:
```json
{
  "moodDistribution": [
    { "bucket": "1-3", "count": 12 },
    { "bucket": "4-6", "count": 45 },
    { "bucket": "7-10", "count": 89 }
  ],
  "statusBreakdown": { "active": 120, "crisis": 4, "inactive": 22 },
  "assessmentCompletion": { "phq9": 0.78, "gad7": 0.72, "asrm": 0.34 },
  "adherenceRate": 0.81
}
```

### 9.2 Patient Cohort Builder

**File:** `apps/web/src/pages/CohortPage.tsx` (NEW)

A drag-and-drop query builder that constructs OMOP-based patient cohort filters and exports de-identified data. Accessible only to users with role `researcher` or `admin`.

**Cohort filter criteria:**
- Diagnosis (OMOP concept IDs, mapped from ICD-10)
- Age range (18–90)
- PHQ-9 severity band (none / mild / moderate / moderately-severe / severe)
- GAD-7 severity band
- ASRM ≥ 6 (probable mania filter)
- Active medication (RxNorm code search)
- Tracking streak ≥ N days
- Registered date range

**UI components:**
- Filter row — `CohortFilterRow.tsx` — criterion selector (dropdown) + operator (is / is not / ≥ / ≤) + value (text/select).
- "Add filter" button.
- Live count: "**47** patients match these criteria" (debounced, `GET /research/cohort-count?filters=...`).
- "Export Cohort" button → `POST /research/export` → polling status → download.

**New API endpoints:**

```
GET  /api/v1/research/cohort-count    Admin/Researcher — count patients matching filter JSON
GET  /api/v1/research/omop-concepts   Admin/Researcher — search OMOP concept IDs
```

### 9.3 Advanced Patient Detail Page

**File:** `apps/web/src/pages/PatientDetailPage.tsx` (EDIT)

Several enhancements to the existing patient detail page:

**Mood heatmap improvements:**
- Extend from 30 days to 90 days with a scrollable horizontal viewport.
- Hover tooltip showing: mood, sleep hours, medication adherence, any alerts on that day.
- Click a day → jump to timeline view filtered to that date.

**Assessment history chart:**
- New sub-tab within the Assessments tab: "History".
- Line chart (Recharts LineChart) plotting PHQ-9, GAD-7, and ASRM scores over time.
- Reference lines at clinical cut-offs (PHQ-9 ≥ 10 = moderate, ≥ 20 = severe; GAD-7 ≥ 10 = moderate; ASRM ≥ 6 = probable mania).
- Clinician can add a note to any assessment score point (inline annotation).

**Side-by-side comparison:**
- "Compare with previous period" toggle — shows current month vs previous month mood chart side by side.

**Quick actions bar:**
- Fixed footer on Patient Detail: "Add Note" · "Request Assessment" · "Generate Report" · "Escalate Alert" (if active crisis alert exists).

### 9.4 Clinician Productivity Features

**Files changed:**

| File | Change |
|------|--------|
| `apps/web/src/pages/DashboardPage.tsx` | Add "My Alerts" priority inbox with action buttons inline |
| `apps/web/src/components/QuickNotePanel.tsx` | NEW — slide-in panel for adding a note without navigating away |
| `apps/web/src/components/AssessmentRequestModal.tsx` | NEW — send push notification to patient requesting a specific assessment |
| `apps/web/src/hooks/useKeyboardShortcuts.ts` | NEW — `N` = new note, `A` = alerts, `P` = patients, `/` = search |

**Keyboard shortcuts** (accessible via `?` overlay in the UI):

| Key | Action |
|-----|--------|
| `N` | Focus new note panel (last-viewed patient) |
| `A` | Jump to Alerts page |
| `P` | Jump to Patients page |
| `/` | Focus global search |
| `Esc` | Close any open modal |

**Assessment request flow:**
- Clinician opens `AssessmentRequestModal`, selects scale (PHQ-9, GAD-7, C-SSRS, etc.).
- `POST /api/v1/notifications/send-assessment-request { patientId, scale }`.
- API sends push notification to patient: "Dr. {Name} has requested a {scale} assessment."
- Tapping notification on mobile → opens `assessments/[scale].tsx` directly.

**New API endpoint:**

```
POST /api/v1/notifications/send-assessment-request    Clinician — push request to patient
```

### 9.5 Global Search

**File:** `apps/web/src/components/GlobalSearch.tsx` (NEW)

Command-palette style search (triggered by `/` or CMD+K):
- Search patients by name, MRN, email (with debounce 200ms).
- Search clinical notes full-text (PostgreSQL `tsvector` — requires migration 011 to add `search_vector` column to `clinician_notes`).
- Shows results in grouped list: Patients / Notes / Assessments.
- Arrow keys to navigate, Enter to navigate to result.

**New API endpoint:**

```
GET /api/v1/search?q=:query&types=patients,notes   Clinician — global search
```

Internally uses `pg_trgm` extension (already enabled) for fuzzy patient name matching, and `to_tsquery` for full-text note search.

---

## 10. Phase 6 — Infrastructure, Testing & Compliance Hardening

**Duration:** Weeks 7–12 (runs concurrently with Phases 3–5 from week 7)
**Goal:** Test coverage to 80%+, automated CI/CD, production monitoring, HIPAA audit hardening, and final release engineering.

### 10.1 Test Suite Architecture

**Testing stack:**

| Layer | Tool | Coverage target |
|-------|------|-----------------|
| API integration tests | `vitest` + `@fastify/inject` + `testcontainers` (Postgres + Redis) | 85% of routes |
| API unit tests (services, workers) | `vitest` | 90% of service functions |
| Mobile component tests | `@testing-library/react-native` + `jest` | 70% of components |
| Mobile E2E | `maestro` (local device test runner) | Critical flows only |
| Web unit tests | `vitest` + `@testing-library/react` | 80% of components |
| Web E2E | `playwright` (already in `devDependencies`) | All 9 pages + critical user journeys |

**New files:**

```
apps/api/src/__tests__/
  auth.test.ts                Integration tests for all auth routes
  patients.test.ts
  daily-entries.test.ts
  alerts.test.ts
  invites.test.ts
  assessments.test.ts
  insights.test.ts
  fhir.test.ts
  helpers/
    testDb.ts               Spin up testcontainers Postgres, run migrations, seed
    testApp.ts              Build Fastify app in test mode (no real Redis/Supabase)
    mockSupabase.ts         vi.mock for supabase.auth.admin

apps/mobile/
  __tests__/
    screens/
      Today.test.tsx
      Journal.test.tsx
      Insights.test.tsx
      onboarding-consent.test.tsx
      onboarding-intake.test.tsx
    components/
      Card.test.tsx
      SkeletonCard.test.tsx
      VoiceRecorder.test.tsx
    services/
      auth.test.ts
      healthData.test.ts

apps/web/
  src/__tests__/
    pages/
      DashboardPage.test.tsx
      PatientDetailPage.test.tsx
      PatientsPage.test.tsx
    components/
      InvitePatientModal.test.tsx
      GlobalSearch.test.tsx
  e2e/
    auth.spec.ts           Playwright: login, MFA, logout
    patient-detail.spec.ts
    invite-flow.spec.ts
    reports.spec.ts
    alerts.spec.ts
```

**API test helper pattern:**

```typescript
// helpers/testDb.ts
const { container, connectionString } = await new PostgreSqlContainer()
  .withDatabase('mindlog_test')
  .start();
await runMigrations(connectionString);
await seedTestData(connectionString);

// helpers/testApp.ts
const app = await buildApp({ databaseUrl: connectionString, redisUrl: mockRedisUrl });
```

Each API test file follows the pattern: `beforeAll` (start containers + app), `afterEach` (truncate mutable tables), `afterAll` (stop containers).

### 10.2 CI/CD Pipeline

**File:** `.github/workflows/ci.yml` (NEW)

```yaml
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20, cache: npm }
      - run: npm ci
      - run: npm run lint
      - run: npm run typecheck

  test-api:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:17
        env: { POSTGRES_DB: mindlog_test, POSTGRES_PASSWORD: test }
        options: --health-cmd pg_isready
      redis:
        image: redis:7-alpine
        options: --health-cmd "redis-cli ping"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20, cache: npm }
      - run: npm ci
      - run: npm run test --workspace=apps/api -- --coverage

  test-web:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20, cache: npm }
      - run: npm ci
      - run: npm run test --workspace=apps/web -- --coverage
      - run: npx playwright install chromium
      - run: npm run test:e2e --workspace=apps/web

  test-mobile:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20, cache: npm }
      - run: npm ci
      - run: npm run test --workspace=apps/mobile -- --coverage

  coverage-report:
    needs: [test-api, test-web, test-mobile]
    runs-on: ubuntu-latest
    steps:
      - uses: codecov/codecov-action@v4
        with: { token: ${{ secrets.CODECOV_TOKEN }} }
```

**File:** `.github/workflows/deploy.yml` (NEW) — triggers on merge to `main`:

```yaml
jobs:
  deploy-api:
    # SSH to production server, git pull, npm install, npm run build, pm2 reload

  deploy-web:
    # npm run build --workspace=apps/web
    # rsync dist/ to nginx root

  eas-build:
    # eas build --profile production --non-interactive
    # Only on tagged releases (v1.1.*)
```

### 10.3 Error Monitoring — Sentry

**New dependency:** `@sentry/node` (API), `@sentry/react-native` (mobile), `@sentry/react` (web).

**Files changed:**

| File | Change |
|------|--------|
| `apps/api/src/server.ts` | Add `Sentry.init()` + `@sentry/node/fastify` integration |
| `apps/mobile/app/_layout.tsx` | Add `Sentry.init()` with `expo-dev-client` integration |
| `apps/web/src/main.tsx` | Add `Sentry.init()` |

**Sentry configuration:**
- DSN from `SENTRY_DSN` env var.
- `tracesSampleRate: 0.1` in production (10% of transactions sampled for performance).
- PII scrubbing: all Sentry events must pass through a `beforeSend` hook that strips `email`, `name`, `phone`, `date_of_birth` from event data. This is required for HIPAA compliance even with a Sentry BAA.
- Source maps uploaded as part of the EAS build post-hook.

**Alert thresholds:**
- Error rate > 1% of requests → PagerDuty alert.
- P95 API response time > 500ms → Sentry Performance alert.

### 10.4 HIPAA Hardening Audit

A systematic review of every data flow against the HIPAA Security Rule (45 CFR §164.302–318).

**Technical Safeguards checklist (§164.312):**

| Safeguard | Status now | v1.1 action |
|-----------|-----------|-------------|
| Access control — unique user IDs | ✅ Supabase Auth + JWT | No change |
| Access control — minimum necessary | ⚠️ Partial | Add column-level restrictions; clinicians can't query patients outside their org |
| Audit controls | ✅ `audit_logs` table | Extend to cover FHIR export events, AI inference events |
| Integrity — transmission | ✅ HTTPS + TLS 1.3 | Enforce `ssl_protocols TLSv1.3` in nginx |
| Authentication — person | ✅ MFA for clinicians | Enforce MFA for all admin-role clinicians (currently optional for non-admin) |
| Encryption at rest | ⚠️ Unknown | Enable PostgreSQL tablespace encryption; document storage encryption |
| Automatic logoff | ✅ 15-min JWT | Add idle-timeout on web dashboard (auto-logout after 15min inactivity) |
| Emergency access | ❌ Not documented | Document break-glass procedure in runbook |

**Additional hardening tasks:**

1. **Rate limiting tightening:** Current `@fastify/rate-limit` config — tighten to 30 requests/15s on auth routes, 60/min on data routes (down from current unconfigured defaults).
2. **SQL injection review:** Audit all raw queries in `packages/db/src/client.ts` for parameterised query usage.
3. **JWT secret rotation procedure:** Document and script zero-downtime JWT secret rotation (issue new tokens on refresh, maintain old secret for 15-min grace period).
4. **Data retention policy:** Add a nightly job to purge `audit_logs` older than 7 years (HIPAA minimum) and `notification_logs` older than 90 days.
5. **`X-Forwarded-For` spoofing:** Validate `TRUSTED_PROXIES` env var is set; trust only the nginx proxy IP in rate limiting.

**File:** `HIPAA_SECURITY_POLICY.md` (NEW — not committed; generated as an internal document) — documents all technical, administrative, and physical safeguards in place.

### 10.5 Performance Optimisation

**API:**
- Add PostgreSQL indexes revealed by `EXPLAIN ANALYZE` on the 5 slowest queries (typically: caseload query, insights aggregation, alert filtering).
- Enable `pg_stat_statements` to identify slow queries in production.
- Add response caching to `GET /clinicians/snapshot` (Redis 30-minute TTL, invalidated on daily entry submit).
- Implement connection pooling via `PgBouncer` in transaction mode (configured in INSTALLER.sh production flow).

**Mobile:**
- Hermes engine already enabled in Expo 52 — no change.
- Add `react-native-fast-image` for image caching (profile photos, if added in a future phase).
- Defer loading of heavy assessment screens using Expo Router's `lazy` option.
- Profile WatermelonDB query time using `__DEV__` logs; add indexes on `watermelon_sync_changed_at` if missing.

**Web:**
- Enable Vite code splitting by route (already works with `React.lazy` + `Suspense`).
- Move large chart components to dynamic imports.
- Analyse bundle with `vite-bundle-analyzer`; target < 300 KB initial load.

### 10.6 Database Backup & Recovery

**File:** `scripts/backup.sh` (NEW)

```bash
#!/usr/bin/env bash
# Daily PostgreSQL backup to encrypted archive
pg_dump "$DATABASE_URL" | gzip | openssl enc -aes-256-cbc -pbkdf2 \
  -pass "env:BACKUP_ENCRYPTION_KEY" > "/backups/mindlog-$(date +%Y%m%d).sql.gz.enc"
# Retain 30 days; delete older
find /backups -name "mindlog-*.sql.gz.enc" -mtime +30 -delete
```

Systemd timer: daily at 03:30 (after nightly scheduler). Verified by a weekly restore test (`scripts/backup-restore-test.sh`).

**Recovery time objective (RTO):** < 4 hours.
**Recovery point objective (RPO):** < 24 hours.

---

## 11. Cross-Cutting Concerns

### 11.1 Clinician Mobile App (Future Phase — scoped here)

The current architecture assumes clinicians only use the web dashboard. v1.1 does **not** build a clinician mobile app but makes the API ready for one by ensuring all clinician endpoints are mobile-friendly:
- All list endpoints support cursor-based pagination (not offset).
- All responses include an `ETag` header for conditional `GET` (avoids re-downloading unchanged data).
- `GET /clinicians/caseload` returns a compact summary mode (`?compact=true`) for small screens.

### 11.2 Internationalisation Foundation

MindLog v1.1 does not ship i18n but lays the groundwork:
- All hardcoded user-facing strings in the mobile app moved to `apps/mobile/i18n/en.ts`.
- Date formatting uses `date-fns/locale` with a locale preference stored in the patient record.
- The web dashboard uses `Intl.DateTimeFormat` consistently (no raw `toLocaleDateString()` calls).
- No UI for language switching in v1.1; this is a v1.2 feature.

### 11.3 Crisis Safety Plan

A structured crisis safety plan form is a clinical best practice for patients with suicidal ideation. v1.1 adds the data model; the full UI is v1.2.

**Migration 011 addition:**

```sql
CREATE TABLE crisis_safety_plans (
  id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  patient_id          UUID NOT NULL REFERENCES patients(id) UNIQUE,
  warning_signs       TEXT[],                    -- "I start to withdraw from friends"
  coping_strategies   TEXT[],                    -- "Go for a walk", "Listen to music"
  support_contacts    JSONB,                     -- [{ name, phone, relationship }]
  crisis_line_phone   TEXT NOT NULL DEFAULT '988',
  professional_contact_name  TEXT,
  professional_contact_phone TEXT,
  emergency_steps     TEXT,                      -- free text
  means_restriction   TEXT,                      -- free text, clinician-documented
  created_at          TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at          TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  completed_by        UUID REFERENCES clinicians(id)
);
```

API endpoint added but mobile/web UI deferred to v1.2:
```
GET    /api/v1/patients/:id/safety-plan    Clinician + Patient
PUT    /api/v1/patients/:id/safety-plan    Clinician
```

### 11.4 Nightly Scheduler Additions

**File:** `apps/api/src/workers/nightly-scheduler.ts` (EDIT)

Add to the nightly 02:00 job:
1. Expire stale `patient_invites` (`UPDATE ... SET status='expired' WHERE status='pending' AND expires_at < NOW()`).
2. Enqueue `generate_weekly_summary` jobs for all patients with AI consent (Sunday only).
3. Run `risk_stratification` job for all active patients.
4. Purge `notification_logs` older than 90 days.
5. Refresh `population_snapshots` for all clinicians.

---

## 12. New Dependencies

### API (`apps/api/package.json`)

| Package | Version | Purpose |
|---------|---------|---------|
| `openai` | `^4.x` | Whisper STT transcription |
| `@fhir-typescript/r4-core` | `^2.x` | FHIR R4 type definitions + schema |
| `@sentry/node` | `^8.x` | Error monitoring |
| `pdfmake` | `^0.2.x` | Alternative PDF renderer for CDA (lighter than Puppeteer for XML) |

### Mobile (`apps/mobile/package.json`)

| Package | Version | Purpose |
|---------|---------|---------|
| `react-native-health` | `^1.x` | HealthKit (iOS) |
| `react-native-health-connect` | `^2.x` | Health Connect (Android) |
| `@sentry/react-native` | `^6.x` | Error monitoring |
| `expo-av` | `~15.x` | Audio recording for voice journaling |

### Web (`apps/web/package.json`)

| Package | Version | Purpose |
|---------|---------|---------|
| `@sentry/react` | `^8.x` | Error monitoring |
| `vite-bundle-analyzer` | `^0.x` | Bundle size analysis (dev only) |

### Shared / root

| Package | Where | Purpose |
|---------|-------|---------|
| `testcontainers` | `apps/api devDependencies` | PostgreSQL + Redis containers for tests |
| `@playwright/test` | `apps/web devDependencies` | Already present |
| `maestro` | External CLI (not npm) | Mobile E2E testing |

---

## 13. Database Migrations Summary

| Migration | Phase | Key additions |
|-----------|-------|---------------|
| **009** `passive_health_data.sql` | 2 | `passive_health_snapshots` table (step count, HRV, sleep stages) |
| **010** `ai_insights.sql` | 3 | `patient_ai_insights`, `ai_usage_log` |
| **011** `search_risk_score.sql` | 3, 5 | `patients.risk_score` column, `patients.risk_score_factors` JSONB, `tsvector` column on `clinician_notes` for full-text search |
| **012** `research_exports.sql` | 4 | `research_exports` table, `cohort_definitions` table |
| **013** `crisis_safety_plan.sql` | Cross-cutting | `crisis_safety_plans` table |

All migrations use the same pattern as existing migrations:
- Idempotent (`CREATE TABLE IF NOT EXISTS`, `ADD COLUMN IF NOT EXISTS`)
- Transactional (wrapped in `BEGIN/COMMIT`)
- Forward-only (no `DOWN` migrations — use restore from backup for rollback)

---

## 14. API Surface Changes

### New endpoints added in v1.1

| Method | Path | Phase | Auth |
|--------|------|-------|------|
| `POST` | `/auth/register` | 1 | Public |
| `PATCH` | `/patients/me/intake` | 1 | Patient |
| `POST` | `/invites` | 1 | Clinician |
| `GET` | `/invites` | 1 | Clinician |
| `GET` | `/invites/validate/:token` | 1 | Public |
| `POST` | `/invites/:id/resend` | 1 | Clinician |
| `DELETE` | `/invites/:id` | 1 | Clinician |
| `POST` | `/voice/transcribe` | 2 | Patient |
| `POST` | `/health-data/sync` | 2 | Patient |
| `GET` | `/insights/me/ai` | 3 | Patient + aiGate |
| `GET` | `/insights/me/ai/history` | 3 | Patient + aiGate |
| `POST` | `/insights/:id/ai/trigger` | 3 | Clinician + aiGate |
| `GET` | `/insights/:id/ai` | 3 | Clinician + aiGate |
| `GET` | `/fhir/Patient/:id` | 4 | Clinician |
| `GET` | `/fhir/Patient/:id/$everything` | 4 | Clinician |
| `GET` | `/fhir/Observation` | 4 | Clinician |
| `GET` | `/fhir/MedicationRequest` | 4 | Clinician |
| `GET` | `/fhir/QuestionnaireResponse` | 4 | Clinician |
| `GET` | `/fhir/Condition` | 4 | Clinician |
| `GET` | `/fhir/CarePlan` | 4 | Clinician |
| `GET` | `/fhir/Consent` | 4 | Clinician |
| `GET` | `/fhir/metadata` | 4 | Public |
| `POST` | `/research/export` | 4 | Admin |
| `GET` | `/research/export/:id` | 4 | Admin |
| `GET` | `/research/cohort-count` | 5 | Admin/Researcher |
| `GET` | `/research/omop-concepts` | 5 | Admin/Researcher |
| `GET` | `/clinicians/population-breakdown` | 5 | Clinician |
| `GET` | `/search` | 5 | Clinician |
| `POST` | `/notifications/send-assessment-request` | 5 | Clinician |
| `GET` | `/patients/:id/safety-plan` | Cross-cutting | Clinician + Patient |
| `PUT` | `/patients/:id/safety-plan` | Cross-cutting | Clinician |

### Existing endpoints modified

| Endpoint | Change |
|----------|--------|
| `GET /insights/me` | Add passive health correlation fields to response |
| `POST /reports` | Add `report_type: 'cda_handover'` |
| Nightly scheduler | Add 5 new job types |

### Breaking changes: none

All existing endpoints retain their request/response shape. New optional fields added to responses where applicable.

---

## 15. Compliance & Regulatory Checkpoints

### Before clinical pilot (must be complete)

| Item | Owner | Target date |
|------|-------|-------------|
| HIPAA Risk Analysis (formal, documented) | Compliance | Week 8 |
| Supabase Enterprise BAA execution | Legal | Week 4 |
| Anthropic BAA execution (if AI enabled) | Legal | Week 6 |
| Resend BAA execution (email PHI) | Legal | Week 2 |
| Sentry BAA execution (if Sentry selected) | Legal | Week 7 |
| Penetration test (external vendor) | Security | Week 10 |
| HIPAA Security Officer designation | HR | Week 1 |
| HIPAA Privacy Officer designation | HR | Week 1 |
| Business Associate Agreements with all pilot clinics | Legal | Week 10 |
| Incident response plan documented | Compliance | Week 9 |
| Workforce HIPAA training (all team members) | HR | Week 3 |

### FDA SaMD classification

MindLog is likely a **Software as a Medical Device (SaMD)** under 21 CFR Part 820. The current intended use (monitoring patient-reported outcomes and alerting clinicians) likely places it in:
- **FDA Device Software Framework:** Class II, moderate risk
- **IEC 62304 classification:** Software Safety Class B (injury is unlikely to be serious or life-threatening — assuming the software is not intended for real-time critical decision making)

v1.1 tasks:
- Initiate formal FDA device classification determination (consult with regulatory affairs specialist).
- Begin maintaining a Software Bill of Materials (SBOM) — required for IEC 62304.
- Establish a Quality Management System (QMS) per ISO 13485 if Class II designation is confirmed.

---

## 16. Risk Register

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Anthropic BAA not executed before AI launch | High | High | AI features gated by `ANTHROPIC_BAA_SIGNED=true`; cannot enable without it |
| HealthKit/Health Connect permission rejection by Apple/Google review | Medium | Medium | Use only approved data categories; document clinical use case in app review notes |
| FHIR endpoint adoption by EHR vendors slower than expected | Medium | Low | Treat FHIR as optional integration; core product doesn't depend on it |
| EAS build signing certificate expiry | Medium | High | Certificate expiry alerts in CI; dedicated Apple Developer + Google Play accounts |
| Whisper API latency > 5s for voice transcription | Medium | Medium | Show "Transcribing..." skeleton; allow cancellation; fall back to manual entry |
| WatermelonDB sync conflicts on multi-device patient | Low | Medium | Conflict resolution strategy: server wins for clinical data; document in sync handler |
| React Native 0.76 breaking change in future Expo SDK | Low | High | Pin `expo` and `react-native` versions; upgrade only after testing |
| Testcontainers slow startup in CI (>2min) | Medium | Low | Use service containers in GitHub Actions (faster than testcontainers) |

---

## 17. Success Metrics

### Engineering metrics (at v1.1 release)

| Metric | Target |
|--------|--------|
| API test coverage | ≥ 85% |
| Mobile component test coverage | ≥ 70% |
| Web component test coverage | ≥ 80% |
| Build time (CI — API tests) | < 3 minutes |
| Build time (CI — full pipeline) | < 8 minutes |
| API P95 response time (production) | < 250ms |
| Mobile app cold start | < 2s (Hermes) |
| Web LCP (Largest Contentful Paint) | < 1.5s |
| Zero critical security vulnerabilities (npm audit) | ✅ |

### Clinical metrics (at end of pilot, ~3 months post v1.1)

| Metric | Target |
|--------|--------|
| Daily check-in completion rate | ≥ 70% of enrolled patients |
| Medication adherence logging rate | ≥ 60% |
| Clinician alert response time (median) | < 4 hours |
| Patient onboarding completion rate | ≥ 85% of invited patients |
| Voice journal usage | ≥ 20% of journal entries |
| HealthKit/Health Connect opt-in | ≥ 50% of iOS patients |
| Passive data correlation improves mood prediction | Measured by r² comparison vs manual-only baseline |

---

## 18. File Change Master List

### New files

```
# Phase 1
apps/api/src/services/messaging.ts
apps/api/src/routes/invites/index.ts
apps/mobile/app/onboarding-consent.tsx
apps/mobile/app/onboarding-intake.tsx
packages/db/migrations/009_passive_health.sql

# Phase 2
apps/mobile/services/healthData.ts
apps/mobile/components/VoiceRecorder.tsx
apps/mobile/hooks/useColorScheme.ts
apps/mobile/utils/a11y.ts
apps/api/src/routes/voice/index.ts
apps/api/src/routes/health-data/index.ts

# Phase 3
apps/api/src/workers/ai-insights-worker.ts
apps/api/src/middleware/aiGate.ts
apps/api/src/services/riskScoring.ts
packages/db/migrations/010_ai_insights.sql
packages/db/migrations/011_search_risk_score.sql

# Phase 4
apps/api/src/routes/fhir/index.ts
apps/api/src/services/fhir/mappers.ts
apps/api/src/services/fhir/validator.ts
apps/api/src/services/cdaGenerator.ts
apps/api/src/routes/research/index.ts
packages/db/migrations/012_research_exports.sql
packages/db/migrations/013_crisis_safety_plan.sql

# Phase 5
apps/web/src/pages/CohortPage.tsx
apps/web/src/components/QuickNotePanel.tsx
apps/web/src/components/AssessmentRequestModal.tsx
apps/web/src/components/GlobalSearch.tsx
apps/web/src/hooks/useKeyboardShortcuts.ts

# Phase 6
.github/workflows/ci.yml
.github/workflows/deploy.yml
scripts/backup.sh
scripts/backup-restore-test.sh
apps/api/src/__tests__/  (8 test files)
apps/api/src/__tests__/helpers/  (3 helper files)
apps/mobile/__tests__/  (12 test files)
apps/web/src/__tests__/  (7 test files)
apps/web/e2e/  (5 playwright spec files)
```

### Edited files

```
# Phase 1
apps/api/src/routes/auth.ts                  (add POST /auth/register)
apps/api/src/routes/patients/me.ts           (add PATCH /patients/me/intake)
apps/api/src/routes/index.ts                 (register invites, voice, health-data routes)
apps/api/src/workers/nightly-scheduler.ts    (expire invites, AI jobs, cleanup)
apps/mobile/app.json                         (deep link scheme, health permissions)
apps/mobile/app/_layout.tsx                  (Linking handler, intake_complete guard)
apps/mobile/app/onboarding.tsx               (add Create Account tab)
apps/mobile/services/auth.ts                 (add INTAKE_COMPLETE key)
apps/web/src/components/InvitePatientModal.tsx  (complete API wiring)
apps/web/src/pages/PatientsPage.tsx          (invite button, pending badges)
apps/web/src/pages/PatientDetailPage.tsx     (invite status card, AI tab, enhanced charts)
packages/shared/src/schemas/index.ts         (RegisterSchema, IntakeSchema, CreateInviteSchema)

# Phase 2
apps/mobile/constants/DesignTokens.ts        (dark mode tokens)
apps/mobile/app/settings/index.tsx           (appearance toggle)
apps/mobile/app/(tabs)/journal.tsx           (voice recording button)
apps/mobile/app/(tabs)/index.tsx             (passive health summary card)
apps/mobile/eas.json                         (complete production config)

# Phase 3
apps/api/src/routes/insights/index.ts        (add AI endpoints)
apps/mobile/app/(tabs)/insights.tsx          (AI insights section)

# Phase 4
apps/api/src/routes/reports/index.ts         (add CDA handover report type)

# Phase 5
apps/web/src/pages/TrendsPage.tsx            (population analytics panels)
apps/web/src/pages/DashboardPage.tsx         (priority inbox, keyboard shortcuts)
apps/web/src/stores/ui.ts                    (add search state)

# Phase 6
apps/api/src/server.ts                       (Sentry init)
apps/mobile/app/_layout.tsx                  (Sentry init — also Phase 1 edit)
apps/web/src/main.tsx                        (Sentry init)
package.json                                 (add build scripts)
.gitignore                                   (already updated with logs/)
INSTALLER.sh                                 (add PgBouncer step, add Sentry DSN prompt)
```

---

*End of MindLog Version 1.1 Development Plan*
*Document maintained by engineering. Review and update at the start of each phase.*
